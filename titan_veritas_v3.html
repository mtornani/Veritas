<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITAN VERITAS v3 - Intelligence Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-card: #1c2128;
            --bg-elevated: #252c35;
            --accent-primary: #2f81f7;
            --accent-secondary: #1f6feb;
            --accent-success: #238636;
            --accent-warning: #d29922;
            --accent-danger: #da3633;
            --accent-gold: #c9a227;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --border-primary: #30363d;
            --border-secondary: #21262d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'IBM Plex Sans', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        .container { max-width: 960px; margin: 0 auto; padding: 16px; }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-primary);
            margin-bottom: 24px;
        }

        .header-left { display: flex; align-items: center; gap: 16px; }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .logo-text h1 {
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .logo-text span {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-family: 'IBM Plex Mono', monospace;
        }

        .header-badge {
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-family: 'IBM Plex Mono', monospace;
            color: var(--text-secondary);
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: 4px;
            background: var(--bg-secondary);
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .nav-item {
            flex: 1;
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .nav-item:hover { color: var(--text-primary); background: var(--bg-elevated); }

        .nav-item.active {
            background: var(--bg-card);
            color: var(--text-primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .nav-icon { font-size: 1rem; }

        /* Panels */
        .panel { display: none; }
        .panel.active { display: block; }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .card-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-secondary);
            font-weight: 600;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-secondary);
        }

        .card-body { padding: 16px; }

        /* Form Elements */
        .form-group { margin-bottom: 16px; }

        .form-label {
            display: block;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
            transition: border-color 0.15s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(47, 129, 247, 0.15);
        }

        .form-textarea { min-height: 100px; resize: vertical; font-size: 0.8125rem; }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .form-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border: 1px solid transparent;
            border-radius: 6px;
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: #fff;
        }

        .btn-primary:hover { background: var(--accent-secondary); }

        .btn-secondary {
            background: var(--bg-elevated);
            border-color: var(--border-primary);
            color: var(--text-primary);
        }

        .btn-secondary:hover { background: var(--bg-card); border-color: var(--text-muted); }

        .btn-success { background: var(--accent-success); color: #fff; }
        .btn-warning { background: var(--accent-warning); color: #000; }
        .btn-danger { background: var(--accent-danger); color: #fff; }

        .btn-sm { padding: 6px 12px; font-size: 0.8125rem; }
        .btn-block { width: 100%; }

        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

        /* Checkbox Grid */
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8125rem;
            transition: all 0.15s;
        }

        .checkbox-item:hover { border-color: var(--border-primary); }
        .checkbox-item input { margin: 0; }

        /* Alert */
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 0.8125rem;
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .alert-info {
            background: rgba(47, 129, 247, 0.1);
            border: 1px solid rgba(47, 129, 247, 0.3);
            color: var(--accent-primary);
        }

        .alert-warning {
            background: rgba(210, 153, 34, 0.1);
            border: 1px solid rgba(210, 153, 34, 0.3);
            color: var(--accent-warning);
        }

        .alert-icon { font-size: 1rem; flex-shrink: 0; }

        /* Progress */
        .progress-wrapper { margin: 16px 0; }

        .progress-bar {
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-success));
            transition: width 0.3s;
        }

        .progress-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 6px;
            text-align: center;
            font-family: 'IBM Plex Mono', monospace;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--accent-primary);
            font-family: 'IBM Plex Mono', monospace;
        }

        .stat-value.warning { color: var(--accent-warning); }
        .stat-value.success { color: var(--accent-success); }
        .stat-value.danger { color: var(--accent-danger); }

        .stat-label {
            font-size: 0.6875rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 6px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 20px;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .filter-chip:hover { border-color: var(--accent-primary); color: var(--text-primary); }
        
        .filter-chip.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: #fff;
        }

        /* Result Cards */
        .result-card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.15s;
        }

        .result-card:hover { border-color: var(--accent-primary); }

        .result-card.noise {
            opacity: 0.5;
            border-color: var(--accent-danger);
        }

        .result-card.verified {
            border-color: var(--accent-success);
            background: rgba(35, 134, 54, 0.05);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-secondary);
        }

        .result-name {
            font-weight: 600;
            font-size: 0.9375rem;
        }

        .result-badges { display: flex; gap: 6px; }

        .badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-high { background: rgba(218, 54, 51, 0.15); color: var(--accent-danger); border: 1px solid var(--accent-danger); }
        .badge-medium { background: rgba(210, 153, 34, 0.15); color: var(--accent-warning); border: 1px solid var(--accent-warning); }
        .badge-low { background: rgba(35, 134, 54, 0.15); color: var(--accent-success); border: 1px solid var(--accent-success); }
        .badge-noise { background: rgba(110, 118, 129, 0.15); color: var(--text-muted); border: 1px solid var(--text-muted); }
        .badge-verified { background: var(--accent-success); color: #fff; }

        .result-body { padding: 12px 16px; }

        .result-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 10px;
        }

        .result-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .result-meta-item .icon { font-size: 0.875rem; }

        .result-snippet {
            font-size: 0.8125rem;
            color: var(--text-muted);
            background: var(--bg-secondary);
            padding: 10px 12px;
            border-radius: 6px;
            margin: 10px 0;
            line-height: 1.6;
        }

        .result-snippet mark {
            background: rgba(201, 162, 39, 0.3);
            color: var(--accent-gold);
            padding: 1px 3px;
            border-radius: 2px;
        }

        .result-link {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.6875rem;
            color: var(--accent-primary);
            word-break: break-all;
        }

        .result-link a { color: inherit; text-decoration: none; }
        .result-link a:hover { text-decoration: underline; }

        .result-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-secondary);
        }

        .result-actions { display: flex; gap: 8px; }

        .result-noise-reason {
            font-size: 0.75rem;
            color: var(--accent-warning);
            padding: 6px 10px;
            background: rgba(210, 153, 34, 0.1);
            border-radius: 4px;
            margin-top: 8px;
        }

        /* Category Tags */
        .category-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.6875rem;
            font-weight: 600;
            font-family: 'IBM Plex Mono', monospace;
            text-transform: uppercase;
        }

        .category-tag.rare { background: rgba(218, 54, 51, 0.15); color: var(--accent-danger); }
        .category-tag.medium { background: rgba(210, 153, 34, 0.15); color: var(--accent-warning); }
        .category-tag.common { background: rgba(110, 118, 129, 0.15); color: var(--text-muted); }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.875rem;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* Export Preview Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title { font-weight: 600; }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 4px;
        }

        .modal-close:hover { color: var(--text-primary); }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-primary);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Report Preview Styles */
        .report-preview {
            background: #fff;
            color: #1a1a1a;
            padding: 40px;
            border-radius: 8px;
            font-family: 'IBM Plex Sans', sans-serif;
        }

        .report-header {
            text-align: center;
            padding-bottom: 24px;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 24px;
        }

        .report-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .report-subtitle {
            font-size: 0.875rem;
            color: #666;
        }

        .report-watermark {
            display: inline-block;
            background: #dc2626;
            color: #fff;
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 1px;
            margin-top: 12px;
        }

        .report-candidate {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .report-candidate-header {
            background: #f5f5f5;
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .report-candidate-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .report-candidate-badge {
            background: #dc2626;
            color: #fff;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 0.6875rem;
            font-weight: 600;
        }

        .report-candidate-body { padding: 16px; }

        .report-candidate-meta {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }

        .report-meta-item {
            font-size: 0.8125rem;
        }

        .report-meta-label {
            color: #666;
            font-size: 0.6875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .report-candidate-link {
            font-size: 0.75rem;
            color: #2563eb;
            word-break: break-all;
        }

        .report-footer {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 2px solid #e0e0e0;
            text-align: center;
            font-size: 0.75rem;
            color: #666;
        }

        .report-disclaimer {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 24px;
            font-size: 0.8125rem;
        }

        /* Mobile */
        @media (max-width: 640px) {
            .container { padding: 12px; }
            .header { flex-direction: column; gap: 12px; text-align: center; }
            .nav-item { padding: 8px 12px; font-size: 0.8125rem; }
            .nav-item span:not(.nav-icon) { display: none; }
            .checkbox-grid { grid-template-columns: repeat(2, 1fr); }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .form-row { grid-template-columns: 1fr; }
            .result-meta { gap: 10px; }
            .report-candidate-meta { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo-icon">üéØ</div>
                <div class="logo-text">
                    <h1>TITAN VERITAS</h1>
                    <span>Heritage Intelligence Platform v3</span>
                </div>
            </div>
            <div class="header-badge">FSGC ‚Ä¢ RSM</div>
        </header>

        <!-- Navigation -->
        <nav class="nav">
            <button class="nav-item active" data-tab="search">
                <span class="nav-icon">üîç</span>
                <span>Ricerca</span>
            </button>
            <button class="nav-item" data-tab="results">
                <span class="nav-icon">üìä</span>
                <span>Analisi</span>
            </button>
            <button class="nav-item" data-tab="verified">
                <span class="nav-icon">‚úì</span>
                <span>Verificati</span>
            </button>
            <button class="nav-item" data-tab="export">
                <span class="nav-icon">üìÑ</span>
                <span>Report</span>
            </button>
        </nav>

        <!-- Search Panel -->
        <div class="panel active" id="panel-search">
            <div class="card">
                <div class="card-header">
                    <span>üîë</span> Configurazione API
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Serper API Key</label>
                        <input type="password" class="form-input" id="serper-key" placeholder="Inserisci chiave API">
                        <div class="form-hint">Ottieni 2500 ricerche gratuite su <a href="https://serper.dev" target="_blank" style="color: var(--accent-primary);">serper.dev</a></div>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="saveApiKey()">Salva chiave</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span>üìã</span> Database Cognomi
                </div>
                <div class="card-body">
                    <div class="btn-group" style="margin-bottom: 16px;">
                        <button class="btn btn-sm btn-secondary" onclick="loadCognomi('rare')">üî¥ Solo Rari</button>
                        <button class="btn btn-sm btn-secondary" onclick="loadCognomi('medium')">üü° Rari + Medi</button>
                        <button class="btn btn-sm btn-secondary" onclick="loadCognomi('all')">üì¶ Tutti</button>
                    </div>
                    <div class="form-group">
                        <textarea class="form-textarea" id="cognomi-input" placeholder="Un cognome per riga..."></textarea>
                    </div>
                    <div id="cognomi-stats"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span>üåç</span> Aree Geografiche Target
                </div>
                <div class="card-body">
                    <div class="checkbox-grid">
                        <label class="checkbox-item"><input type="checkbox" name="country" value="Argentina" checked> üá¶üá∑ Argentina</label>
                        <label class="checkbox-item"><input type="checkbox" name="country" value="Brazil" checked> üáßüá∑ Brasile</label>
                        <label class="checkbox-item"><input type="checkbox" name="country" value="USA" checked> üá∫üá∏ Stati Uniti</label>
                        <label class="checkbox-item"><input type="checkbox" name="country" value="Uruguay"> üá∫üáæ Uruguay</label>
                        <label class="checkbox-item"><input type="checkbox" name="country" value="Paraguay"> üáµüáæ Paraguay</label>
                        <label class="checkbox-item"><input type="checkbox" name="country" value="Chile"> üá®üá± Cile</label>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span>‚öôÔ∏è</span> Parametri Ricerca
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Et√† Minima</label>
                            <input type="number" class="form-input" id="age-min" value="16" min="14" max="40">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Et√† Massima</label>
                            <input type="number" class="form-input" id="age-max" value="28" min="16" max="45">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Profondit√† Ricerca</label>
                            <select class="form-select" id="search-depth">
                                <option value="1">Veloce (1 query/cognome)</option>
                                <option value="2" selected>Standard (2 query/cognome)</option>
                                <option value="3">Approfondita (3 query/cognome)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Risultati per Query</label>
                            <select class="form-select" id="results-num">
                                <option value="5">5 risultati</option>
                                <option value="10" selected>10 risultati</option>
                                <option value="15">15 risultati</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert alert-info">
                <span class="alert-icon">‚ÑπÔ∏è</span>
                <div>
                    <strong>Filtri Automatici Attivi:</strong> Il sistema esclude automaticamente club RSM, campionati italiani, staff tecnico, allenatori, giocatori ritirati e pagine non pertinenti.
                </div>
            </div>

            <button class="btn btn-primary btn-block" onclick="startSearch()" id="btn-search">
                üöÄ Avvia Analisi Intelligence
            </button>

            <div class="progress-wrapper" id="progress-wrapper" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-label" id="progress-label">Inizializzazione...</div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="panel" id="panel-results">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label">Totale Analizzati</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value success" id="stat-valid">0</div>
                    <div class="stat-label">Candidati Validi</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value danger" id="stat-priority">0</div>
                    <div class="stat-label">Alta Priorit√†</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value warning" id="stat-filtered">0</div>
                    <div class="stat-label">Filtrati</div>
                </div>
            </div>

            <div class="filter-bar">
                <button class="filter-chip active" data-filter="valid">‚úì Validi</button>
                <button class="filter-chip" data-filter="priority">üî¥ Priorit√†</button>
                <button class="filter-chip" data-filter="all">üì¶ Tutti</button>
                <button class="filter-chip" data-filter="filtered">üóëÔ∏è Filtrati</button>
            </div>

            <div id="results-container"></div>
        </div>

        <!-- Verified Panel -->
        <div class="panel" id="panel-verified">
            <div class="alert alert-warning">
                <span class="alert-icon">‚ö†Ô∏è</span>
                <div>
                    <strong>NOTA:</strong> I candidati in questa sezione sono stati selezionati per ulteriore verifica. I dati sono indicativi e richiedono conferma tramite anagrafe RSM.
                </div>
            </div>

            <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="stat-card">
                    <div class="stat-value success" id="stat-verified-count">0</div>
                    <div class="stat-label">Candidati Selezionati</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-verified-priority">0</div>
                    <div class="stat-label">Alta Priorit√†</div>
                </div>
            </div>

            <div id="verified-container"></div>
        </div>

        <!-- Export Panel -->
        <div class="panel" id="panel-export">
            <div class="card">
                <div class="card-header">
                    <span>üìÑ</span> Genera Report
                </div>
                <div class="card-body">
                    <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 0.875rem;">
                        Genera un report professionale dei candidati verificati, pronto per essere presentato al Consiglio Federale FSGC.
                    </p>

                    <div class="form-group">
                        <label class="form-label">Titolo Report</label>
                        <input type="text" class="form-input" id="report-title" value="Candidati Oriundi - Analisi Preliminare">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Note Aggiuntive</label>
                        <textarea class="form-textarea" id="report-notes" placeholder="Eventuali note da includere nel report..."></textarea>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="previewReport()">
                            üëÅÔ∏è Anteprima Report
                        </button>
                        <button class="btn btn-success" onclick="downloadHTML()">
                            üìÑ Scarica HTML
                        </button>
                        <button class="btn btn-secondary" onclick="downloadCSV()">
                            üìä Scarica CSV
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span>‚ÑπÔ∏è</span> Informazioni Report
                </div>
                <div class="card-body">
                    <ul style="color: var(--text-secondary); font-size: 0.875rem; padding-left: 20px;">
                        <li>Il report HTML √® stampabile e pu√≤ essere salvato come PDF</li>
                        <li>Include watermark "CONFIDENZIALE - DA VERIFICARE"</li>
                        <li>Contiene disclaimer sulla natura preliminare dei dati</li>
                        <li>Formattato per presentazione istituzionale</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Preview Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Anteprima Report</span>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Chiudi</button>
                <button class="btn btn-success" onclick="downloadHTML()">üìÑ Scarica HTML</button>
                <button class="btn btn-primary" onclick="printReport()">üñ®Ô∏è Stampa</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ==========================================
        // DATABASE
        // ==========================================
        
        const COGNOMI = {
            rare: [
                "Gasperoni", "Mularoni", "Zonzini", "Zafferani", "Vitaioli", "Bacciocchi",
                "Podeschi", "Muraccini", "Capicchioni", "Volpinari", "Stolfi", "Cioncolini",
                "Tamagnini", "Simoncini", "Matteoni", "Giardi", "Ghiotti", "Maiani", 
                "Raschi", "Cevoli"
            ],
            medium: [
                "Casadei", "Zanotti", "Guidi", "Selva", "Benedettini", "Stefanelli",
                "Della Valle", "Nanni", "Valli", "Pasolini", "Francini", "Felici", 
                "Ercolani", "Michelotti", "Renzetti", "Salvini", "Carchia", "Lombardi",
                "Marquisio", "Riva", "Zoli", "Amati", "Arlotti", "Balducci"
            ],
            common: [
                "Rossi", "Bianchi", "Valentini", "Ceci", "Ferrari", "Fabbri", 
                "Graziani", "Marchetti", "Montanari", "Rinaldi", "Santi"
            ]
        };

        const BLACKLIST = {
            clubs: [
                "la fiorita", "tre penne", "tre fiori", "folgore", "libertas", 
                "cosmos", "murata", "domagnano", "faetano", "pennarossa", 
                "fiorentino", "juvenes", "dogana", "cailungo", "san giovanni",
                "virtus acquaviva", "san marino academy", "san marino calcio",
                "sp cailungo", "sp tre penne", "ss folgore"
            ],
            leagues: [
                "campionato sammarinese", "san marino championship", 
                "serie a", "serie b", "serie c", "serie d", "primavera", "lega pro",
                "eccellenza", "promozione"
            ],
            roles: [
                "manager", "coach", "allenatore", "director", "direttore",
                "president", "presidente", "staff", "academy manager", "scout",
                "agent", "agente", "retired", "ritirato", "ex-", "former"
            ],
            famousPlayers: [
                "messi", "ronaldo", "neymar", "mbappe", "haaland", "de bruyne",
                "iniesta", "xavi", "modric", "kroos", "benzema", "lewandowski",
                "salah", "kane", "son", "griezmann", "pogba", "hazard",
                "robert taylor", "nacer chadli", "guilherme", "ivan piris",
                "kevin de bruyne", "andres iniesta"
            ],
            urlPatterns: [
                "spielegegeneinander", "gegner", "opponents", "against",
                "marktwerte", "market-value", "statistics", "staff",
                "berateruebersicht", "agents", "transfers", "rumours",
                "news", "artikel", "wettbewerb"
            ],
            sports: [
                "volleyball", "pallavolo", "basketball", "pallacanestro",
                "tennis", "rugby", "hockey", "handball", "baseball"
            ]
        };

        // ==========================================
        // STATE
        // ==========================================

        let candidates = JSON.parse(localStorage.getItem('titan_v3_candidates') || '[]');
        let verified = JSON.parse(localStorage.getItem('titan_v3_verified') || '[]');
        let currentFilter = 'valid';

        // ==========================================
        // INITIALIZATION
        // ==========================================

        document.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('serper_api_key');
            if (savedKey) document.getElementById('serper-key').value = savedKey;
            
            // Tab navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => switchTab(item.dataset.tab));
            });

            // Filter chips
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentFilter = chip.dataset.filter;
                    renderResults();
                });
            });

            document.getElementById('cognomi-input').addEventListener('input', updateCognomiStats);
            
            updateStats();
        });

        function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`.nav-item[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`panel-${tabId}`).classList.add('active');
            
            if (tabId === 'results') renderResults();
            if (tabId === 'verified') renderVerified();
        }

        // ==========================================
        // COGNOMI MANAGEMENT
        // ==========================================

        function loadCognomi(level) {
            let list = [];
            if (level === 'rare') list = COGNOMI.rare;
            else if (level === 'medium') list = [...COGNOMI.rare, ...COGNOMI.medium];
            else list = [...COGNOMI.rare, ...COGNOMI.medium, ...COGNOMI.common];
            
            document.getElementById('cognomi-input').value = list.join('\n');
            updateCognomiStats();
            showToast(`Caricati ${list.length} cognomi`);
        }

        function getCognomi() {
            return document.getElementById('cognomi-input').value
                .split('\n')
                .map(c => c.trim())
                .filter(c => c.length > 0);
        }

        function getCognomeCategory(cognome) {
            const c = cognome.toLowerCase();
            if (COGNOMI.rare.map(x => x.toLowerCase()).includes(c)) return 'rare';
            if (COGNOMI.medium.map(x => x.toLowerCase()).includes(c)) return 'medium';
            return 'common';
        }

        function updateCognomiStats() {
            const cognomi = getCognomi();
            const stats = document.getElementById('cognomi-stats');
            
            if (cognomi.length === 0) {
                stats.innerHTML = '';
                return;
            }

            const rare = cognomi.filter(c => getCognomeCategory(c) === 'rare').length;
            const medium = cognomi.filter(c => getCognomeCategory(c) === 'medium').length;
            const common = cognomi.filter(c => getCognomeCategory(c) === 'common').length;

            stats.innerHTML = `
                <div style="display: flex; gap: 12px; font-size: 0.8125rem;">
                    <span><span class="category-tag rare">RARI</span> ${rare}</span>
                    <span><span class="category-tag medium">MEDI</span> ${medium}</span>
                    <span><span class="category-tag common">COMUNI</span> ${common}</span>
                    <span style="color: var(--text-muted);">Totale: ${cognomi.length}</span>
                </div>
            `;
        }

        // ==========================================
        // API KEY
        // ==========================================

        function saveApiKey() {
            const key = document.getElementById('serper-key').value.trim();
            if (key) {
                localStorage.setItem('serper_api_key', key);
                showToast('Chiave API salvata');
            }
        }

        // ==========================================
        // SEARCH ENGINE
        // ==========================================

        async function startSearch() {
            const apiKey = document.getElementById('serper-key').value.trim() || localStorage.getItem('serper_api_key');
            if (!apiKey) return showToast('Inserisci la chiave API');

            const cognomi = getCognomi();
            if (cognomi.length === 0) return showToast('Carica almeno un cognome');

            const countries = Array.from(document.querySelectorAll('input[name="country"]:checked')).map(c => c.value);
            if (countries.length === 0) return showToast('Seleziona almeno un paese');

            const ageMin = parseInt(document.getElementById('age-min').value) || 16;
            const ageMax = parseInt(document.getElementById('age-max').value) || 28;
            const depth = parseInt(document.getElementById('search-depth').value);
            const resultsNum = parseInt(document.getElementById('results-num').value);

            // UI
            document.getElementById('btn-search').disabled = true;
            document.getElementById('progress-wrapper').style.display = 'block';

            const totalSearches = cognomi.length * countries.length * depth;
            let completed = 0;
            let newCandidates = 0;

            for (const cognome of cognomi) {
                for (const country of countries) {
                    const queries = buildQueries(cognome, country, depth);
                    
                    for (const query of queries) {
                        try {
                            updateProgress(completed, totalSearches, `Analisi: ${cognome} (${country})`);
                            
                            const results = await searchSerper(apiKey, query, resultsNum);
                            const processed = processResults(results, cognome, country, ageMin, ageMax);
                            
                            newCandidates += processed;
                            completed++;
                            
                            await sleep(350);
                        } catch (err) {
                            console.error('Search error:', err);
                            completed++;
                        }
                    }
                }
            }

            // Complete
            document.getElementById('btn-search').disabled = false;
            document.getElementById('progress-wrapper').style.display = 'none';
            
            saveCandidates();
            showToast(`Analisi completata: ${newCandidates} nuovi candidati`);
            switchTab('results');
        }

        function buildQueries(cognome, country, depth) {
            const queries = [];
            const countryTerms = {
                'Argentina': 'argentino OR argentina',
                'Brazil': 'brasileiro OR brazil OR brasile',
                'USA': 'american OR usa OR mls',
                'Uruguay': 'uruguayo OR uruguay',
                'Paraguay': 'paraguayo OR paraguay',
                'Chile': 'chileno OR chile'
            };

            // Query 1: Direct player profile search
            queries.push(`site:transfermarkt.com "${cognome}" player profile ${countryTerms[country] || country}`);
            
            if (depth >= 2) {
                if (country === 'Argentina') {
                    queries.push(`site:bdfa.com.ar "${cognome}" jugador perfil`);
                } else if (country === 'Brazil') {
                    queries.push(`site:ogol.com.br "${cognome}" jogador`);
                } else {
                    queries.push(`"${cognome}" footballer soccer player ${country} -"San Marino" -serie -coach -manager`);
                }
            }
            
            if (depth >= 3) {
                queries.push(`site:soccerway.com "${cognome}" player ${country}`);
            }

            return queries;
        }

        async function searchSerper(apiKey, query, num) {
            const response = await fetch('https://google.serper.dev/search', {
                method: 'POST',
                headers: { 'X-API-KEY': apiKey, 'Content-Type': 'application/json' },
                body: JSON.stringify({ q: query, num: num })
            });

            if (!response.ok) throw new Error(`API error: ${response.status}`);
            const data = await response.json();
            return data.organic || [];
        }

        // ==========================================
        // RESULT PROCESSING
        // ==========================================

        function processResults(results, cognome, country, ageMin, ageMax) {
            let added = 0;

            for (const result of results) {
                const analyzed = analyzeResult(result, cognome, country, ageMin, ageMax);
                
                if (!isDuplicate(analyzed)) {
                    candidates.push(analyzed);
                    added++;
                }
            }

            return added;
        }

        function analyzeResult(result, cognome, country, ageMin, ageMax) {
            const title = result.title || '';
            const snippet = result.snippet || '';
            const link = result.link || '';
            const fullText = `${title} ${snippet}`.toLowerCase();

            const noiseReasons = [];

            // Check blacklists
            for (const club of BLACKLIST.clubs) {
                if (fullText.includes(club)) { noiseReasons.push(`Club RSM: ${club}`); break; }
            }

            for (const league of BLACKLIST.leagues) {
                if (fullText.includes(league)) { noiseReasons.push(`Lega esclusa: ${league}`); break; }
            }

            for (const role of BLACKLIST.roles) {
                if (fullText.includes(role)) { noiseReasons.push(`Ruolo non giocatore: ${role}`); break; }
            }

            for (const player of BLACKLIST.famousPlayers) {
                if (title.toLowerCase().includes(player)) { noiseReasons.push(`Giocatore famoso: ${player}`); break; }
            }

            for (const pattern of BLACKLIST.urlPatterns) {
                if (link.toLowerCase().includes(pattern)) { noiseReasons.push(`URL non pertinente`); break; }
            }

            for (const sport of BLACKLIST.sports) {
                if (fullText.includes(sport)) { noiseReasons.push(`Sport diverso: ${sport}`); break; }
            }

            // Check cognome presence
            const cognomeInContent = fullText.includes(cognome.toLowerCase());
            if (!cognomeInContent) {
                noiseReasons.push('Cognome non presente nel contenuto');
            }

            // Extract data
            const playerName = extractPlayerName(title, snippet, cognome);
            const age = extractAge(snippet, title);
            const club = extractClub(snippet);
            const position = extractPosition(fullText);

            // Age filter
            if (age) {
                const ageNum = parseInt(age);
                if (ageNum < ageMin || ageNum > ageMax) {
                    noiseReasons.push(`Et√† fuori range (${age} anni)`);
                }
            }

            // Calculate score
            const category = getCognomeCategory(cognome);
            let score = 0;
            
            if (category === 'rare') score += 4;
            else if (category === 'medium') score += 2;
            else score += 1;

            if (['Argentina', 'Brazil', 'USA'].includes(country)) score += 2;
            if (noiseReasons.length === 0) score += 3;
            if (link.includes('/spieler/') || link.includes('/player/') || link.includes('/jugador')) score += 2;
            if (age && parseInt(age) >= 18 && parseInt(age) <= 25) score += 1;
            if (position) score += 1;

            return {
                id: Date.now() + Math.random(),
                name: playerName,
                surname: cognome,
                category,
                country,
                age,
                club,
                position,
                score,
                isNoise: noiseReasons.length > 0,
                noiseReasons,
                title,
                snippet,
                link,
                addedAt: new Date().toISOString()
            };
        }

        function extractPlayerName(title, snippet, cognome) {
            const patterns = [
                new RegExp(`([A-Z][a-z√†-√ø]+)\\s+${cognome}`, 'i'),
                new RegExp(`${cognome},?\\s+([A-Z][a-z√†-√ø]+)`, 'i'),
                new RegExp(`([A-Z])\\.\\s*${cognome}`, 'i')
            ];

            for (const regex of patterns) {
                const match = title.match(regex) || snippet.match(regex);
                if (match) {
                    if (match[1].length === 1) return `${match[1]}. ${cognome}`;
                    return `${match[1]} ${cognome}`;
                }
            }

            const titleClean = title.split(' - ')[0].split(' | ')[0].trim();
            if (titleClean.length < 35 && titleClean.toLowerCase().includes(cognome.toLowerCase())) {
                return titleClean;
            }

            return `[Verifica] ${cognome}`;
        }

        function extractAge(snippet, title) {
            const combined = `${snippet} ${title}`;
            
            // Direct age mention
            const agePatterns = [
                /(?:age|et√†|edad|idade)[:\s]*(\d{1,2})/i,
                /(\d{1,2})\s*(?:years? old|anni|a√±os|anos)/i,
                /\b(\d{1,2}),\s*(?:born|nato|nacido)/i
            ];

            for (const pattern of agePatterns) {
                const match = combined.match(pattern);
                if (match && parseInt(match[1]) >= 14 && parseInt(match[1]) <= 50) {
                    return match[1];
                }
            }

            // Birth year
            const yearMatch = combined.match(/\b(19[89]\d|200\d|201\d)\b/);
            if (yearMatch) {
                const year = parseInt(yearMatch[1]);
                const age = new Date().getFullYear() - year;
                if (age >= 14 && age <= 50) return age.toString();
            }

            return '';
        }

        function extractClub(snippet) {
            const patterns = [
                /(?:current club|club attuale|clube atual)[:\s]*([A-Za-z√Ä-√ø\s]+?)(?:\.|,|$)/i,
                /(?:plays? for|gioca per|juega en)[:\s]*([A-Za-z√Ä-√ø\s]+?)(?:\.|,|$)/i
            ];

            for (const pattern of patterns) {
                const match = snippet.match(pattern);
                if (match) return match[1].trim().substring(0, 25);
            }

            return '';
        }

        function extractPosition(text) {
            const positions = {
                'goalkeeper': 'Portiere', 'portiere': 'Portiere', 'goleiro': 'Portiere', 'arquero': 'Portiere',
                'defender': 'Difensore', 'difensore': 'Difensore', 'zagueiro': 'Difensore', 'defensor': 'Difensore',
                'centre-back': 'Difensore Centrale', 'central': 'Difensore Centrale',
                'right-back': 'Terzino Destro', 'left-back': 'Terzino Sinistro',
                'midfielder': 'Centrocampista', 'centrocampista': 'Centrocampista', 'meia': 'Centrocampista', 'mediocampista': 'Centrocampista',
                'defensive midfield': 'Mediano', 'attacking midfield': 'Trequartista',
                'forward': 'Attaccante', 'attaccante': 'Attaccante', 'atacante': 'Attaccante', 'delantero': 'Attaccante',
                'striker': 'Punta', 'centre-forward': 'Punta',
                'winger': 'Ala', 'ala': 'Ala', 'right wing': 'Ala Destra', 'left wing': 'Ala Sinistra'
            };

            const textLower = text.toLowerCase();
            for (const [key, value] of Object.entries(positions)) {
                if (textLower.includes(key)) return value;
            }

            return '';
        }

        function isDuplicate(candidate) {
            return candidates.some(c => 
                c.link === candidate.link ||
                (c.name === candidate.name && c.surname === candidate.surname && c.country === candidate.country)
            );
        }

        // ==========================================
        // RENDERING
        // ==========================================

        function renderResults() {
            updateStats();
            const container = document.getElementById('results-container');
            
            let filtered = candidates;
            switch (currentFilter) {
                case 'valid': filtered = candidates.filter(c => !c.isNoise); break;
                case 'priority': filtered = candidates.filter(c => !c.isNoise && c.score >= 7); break;
                case 'filtered': filtered = candidates.filter(c => c.isNoise); break;
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <div class="empty-state-title">Nessun risultato</div>
                        <p>Avvia una ricerca o cambia filtro</p>
                    </div>
                `;
                return;
            }

            filtered.sort((a, b) => b.score - a.score);
            container.innerHTML = filtered.map(c => renderResultCard(c)).join('');
        }

        function renderResultCard(c) {
            const badgeClass = c.isNoise ? 'badge-noise' : (c.score >= 7 ? 'badge-high' : (c.score >= 4 ? 'badge-medium' : 'badge-low'));
            const badgeText = c.isNoise ? 'FILTRATO' : (c.score >= 7 ? 'PRIORIT√Ä ALTA' : (c.score >= 4 ? 'PRIORIT√Ä MEDIA' : 'PRIORIT√Ä BASSA'));
            const isVerified = verified.some(v => v.id === c.id);
            
            const highlightedSnippet = c.snippet.replace(
                new RegExp(`(${c.surname})`, 'gi'),
                '<mark>$1</mark>'
            );

            return `
                <div class="result-card ${c.isNoise ? 'noise' : ''} ${isVerified ? 'verified' : ''}">
                    <div class="result-header">
                        <span class="result-name">${c.name}</span>
                        <div class="result-badges">
                            ${isVerified ? '<span class="badge badge-verified">‚úì SELEZIONATO</span>' : ''}
                            <span class="badge ${badgeClass}">${badgeText}</span>
                        </div>
                    </div>
                    <div class="result-body">
                        <div class="result-meta">
                            <span class="category-tag ${c.category}">${c.surname}</span>
                            ${c.country ? `<span class="result-meta-item"><span class="icon">üåç</span> ${c.country}</span>` : ''}
                            ${c.age ? `<span class="result-meta-item"><span class="icon">üìÖ</span> ${c.age} anni</span>` : ''}
                            ${c.club ? `<span class="result-meta-item"><span class="icon">‚öΩ</span> ${c.club}</span>` : ''}
                            ${c.position ? `<span class="result-meta-item"><span class="icon">üë§</span> ${c.position}</span>` : ''}
                            <span class="result-meta-item"><span class="icon">‚≠ê</span> Score: ${c.score}</span>
                        </div>
                        <div class="result-snippet">${highlightedSnippet}</div>
                        ${c.isNoise ? `<div class="result-noise-reason">‚ö†Ô∏è ${c.noiseReasons.join(' ‚Ä¢ ')}</div>` : ''}
                        <div class="result-link"><a href="${c.link}" target="_blank">${c.link}</a></div>
                    </div>
                    <div class="result-footer">
                        <div class="result-actions">
                            ${!c.isNoise ? `
                                <button class="btn btn-sm ${isVerified ? 'btn-success' : 'btn-secondary'}" onclick="toggleVerify(${c.id})">
                                    ${isVerified ? '‚úì Selezionato' : '‚òê Seleziona'}
                                </button>
                            ` : `
                                <button class="btn btn-sm btn-secondary" onclick="restoreCandidate(${c.id})">
                                    ‚ôªÔ∏è Ripristina
                                </button>
                            `}
                            <button class="btn btn-sm btn-danger" onclick="removeCandidate(${c.id})">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderVerified() {
            updateVerifiedStats();
            const container = document.getElementById('verified-container');

            if (verified.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-title">Nessun candidato selezionato</div>
                        <p>Vai su Analisi e seleziona i candidati promettenti</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = verified.map(c => `
                <div class="result-card verified">
                    <div class="result-header">
                        <span class="result-name">${c.name}</span>
                        <span class="category-tag ${c.category}">${c.surname}</span>
                    </div>
                    <div class="result-body">
                        <div class="result-meta">
                            ${c.country ? `<span class="result-meta-item"><span class="icon">üåç</span> ${c.country}</span>` : ''}
                            ${c.age ? `<span class="result-meta-item"><span class="icon">üìÖ</span> ${c.age} anni</span>` : ''}
                            ${c.club ? `<span class="result-meta-item"><span class="icon">‚öΩ</span> ${c.club}</span>` : ''}
                            ${c.position ? `<span class="result-meta-item"><span class="icon">üë§</span> ${c.position}</span>` : ''}
                        </div>
                        <div class="result-link"><a href="${c.link}" target="_blank">${c.link}</a></div>
                    </div>
                    <div class="result-footer">
                        <button class="btn btn-sm btn-danger" onclick="removeVerified(${c.id})">
                            ‚ùå Rimuovi
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ==========================================
        // ACTIONS
        // ==========================================

        function toggleVerify(id) {
            const candidate = candidates.find(c => c.id === id);
            if (!candidate) return;

            const idx = verified.findIndex(v => v.id === id);
            if (idx >= 0) {
                verified.splice(idx, 1);
                showToast('Rimosso dalla selezione');
            } else {
                verified.push(candidate);
                showToast('Aggiunto alla selezione');
            }

            saveVerified();
            renderResults();
        }

        function restoreCandidate(id) {
            const candidate = candidates.find(c => c.id === id);
            if (candidate) {
                candidate.isNoise = false;
                candidate.noiseReasons = [];
                saveCandidates();
                renderResults();
                showToast('Candidato ripristinato');
            }
        }

        function removeCandidate(id) {
            candidates = candidates.filter(c => c.id !== id);
            verified = verified.filter(v => v.id !== id);
            saveCandidates();
            saveVerified();
            renderResults();
            showToast('Candidato eliminato');
        }

        function removeVerified(id) {
            verified = verified.filter(v => v.id !== id);
            saveVerified();
            renderVerified();
            showToast('Rimosso dalla selezione');
        }

        // ==========================================
        // STATS
        // ==========================================

        function updateStats() {
            const valid = candidates.filter(c => !c.isNoise);
            const priority = valid.filter(c => c.score >= 7);
            const filtered = candidates.filter(c => c.isNoise);

            document.getElementById('stat-total').textContent = candidates.length;
            document.getElementById('stat-valid').textContent = valid.length;
            document.getElementById('stat-priority').textContent = priority.length;
            document.getElementById('stat-filtered').textContent = filtered.length;
        }

        function updateVerifiedStats() {
            const priority = verified.filter(c => c.score >= 7);
            document.getElementById('stat-verified-count').textContent = verified.length;
            document.getElementById('stat-verified-priority').textContent = priority.length;
        }

        // ==========================================
        // EXPORT / REPORT
        // ==========================================

        function generateReportHTML() {
            const title = document.getElementById('report-title').value || 'Candidati Oriundi - Analisi Preliminare';
            const notes = document.getElementById('report-notes').value;
            const date = new Date().toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric' });

            const candidatesHTML = verified.map(c => `
                <div class="report-candidate">
                    <div class="report-candidate-header">
                        <span class="report-candidate-name">${c.name}</span>
                        <span class="report-candidate-badge">${c.category.toUpperCase()}</span>
                    </div>
                    <div class="report-candidate-body">
                        <div class="report-candidate-meta">
                            <div class="report-meta-item">
                                <div class="report-meta-label">Cognome</div>
                                <div>${c.surname}</div>
                            </div>
                            <div class="report-meta-item">
                                <div class="report-meta-label">Paese</div>
                                <div>${c.country || 'N/D'}</div>
                            </div>
                            <div class="report-meta-item">
                                <div class="report-meta-label">Et√†</div>
                                <div>${c.age ? c.age + ' anni' : 'N/D'}</div>
                            </div>
                            <div class="report-meta-item">
                                <div class="report-meta-label">Club</div>
                                <div>${c.club || 'N/D'}</div>
                            </div>
                            <div class="report-meta-item">
                                <div class="report-meta-label">Ruolo</div>
                                <div>${c.position || 'N/D'}</div>
                            </div>
                            <div class="report-meta-item">
                                <div class="report-meta-label">Score</div>
                                <div>${c.score}/10</div>
                            </div>
                        </div>
                        <div class="report-candidate-link">üîó ${c.link}</div>
                    </div>
                </div>
            `).join('');

            return `
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans', sans-serif; background: #f5f5f5; padding: 40px; line-height: 1.6; }
        .report { max-width: 800px; margin: 0 auto; background: #fff; padding: 48px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .report-header { text-align: center; padding-bottom: 32px; border-bottom: 2px solid #e0e0e0; margin-bottom: 32px; }
        .report-logo { font-size: 0.875rem; color: #666; letter-spacing: 2px; margin-bottom: 8px; }
        .report-title { font-size: 1.75rem; font-weight: 700; color: #1a1a1a; margin-bottom: 8px; }
        .report-subtitle { font-size: 0.875rem; color: #666; }
        .report-watermark { display: inline-block; background: #dc2626; color: #fff; padding: 8px 20px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; letter-spacing: 1px; margin-top: 16px; }
        .report-disclaimer { background: #fef3c7; border: 1px solid #f59e0b; border-left: 4px solid #f59e0b; color: #92400e; padding: 16px 20px; margin-bottom: 32px; font-size: 0.875rem; }
        .report-notes { background: #f0f9ff; border: 1px solid #0ea5e9; border-left: 4px solid #0ea5e9; color: #0369a1; padding: 16px 20px; margin-bottom: 32px; font-size: 0.875rem; }
        .report-section-title { font-size: 1rem; font-weight: 600; color: #1a1a1a; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #e0e0e0; }
        .report-candidate { border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 20px; overflow: hidden; page-break-inside: avoid; }
        .report-candidate-header { background: #f5f5f5; padding: 14px 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        .report-candidate-name { font-weight: 600; font-size: 1.0625rem; }
        .report-candidate-badge { background: #1f2937; color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 0.6875rem; font-weight: 600; }
        .report-candidate-body { padding: 20px; }
        .report-candidate-meta { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px; }
        .report-meta-item { }
        .report-meta-label { color: #666; font-size: 0.6875rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
        .report-candidate-link { font-size: 0.75rem; color: #2563eb; word-break: break-all; }
        .report-footer { margin-top: 40px; padding-top: 24px; border-top: 2px solid #e0e0e0; text-align: center; font-size: 0.75rem; color: #666; }
        .report-footer-watermark { color: #dc2626; font-weight: 600; margin-top: 8px; }
        @media print {
            body { padding: 0; background: #fff; }
            .report { box-shadow: none; padding: 24px; }
        }
    </style>
</head>
<body>
    <div class="report">
        <div class="report-header">
            <div class="report-logo">TITAN VERITAS ‚Ä¢ HERITAGE INTELLIGENCE</div>
            <h1 class="report-title">${title}</h1>
            <div class="report-subtitle">Generato il ${date} ‚Ä¢ ${verified.length} candidati</div>
            <div class="report-watermark">‚ö†Ô∏è CONFIDENZIALE ‚Äî DA VERIFICARE</div>
        </div>

        <div class="report-disclaimer">
            <strong>AVVERTENZA:</strong> Il presente documento contiene dati preliminari raccolti tramite fonti pubbliche. 
            Le informazioni qui riportate sono indicative e richiedono <strong>verifica ufficiale</strong> tramite anagrafe 
            della Repubblica di San Marino prima di qualsiasi azione. I candidati elencati rappresentano potenziali soggetti 
            di interesse, non conferme di eleggibilit√†.
        </div>

        ${notes ? `<div class="report-notes"><strong>Note:</strong> ${notes}</div>` : ''}

        <div class="report-section-title">üìã Candidati Selezionati per Verifica</div>

        ${candidatesHTML}

        <div class="report-footer">
            <div>Report generato automaticamente da TITAN VERITAS Intelligence Platform</div>
            <div>Federazione Sammarinese Giuoco Calcio ‚Äî Uso Interno</div>
            <div class="report-footer-watermark">CONFIDENZIALE ‚Äî DA VERIFICARE IN ANAGRAFE</div>
        </div>
    </div>
</body>
</html>`;
        }

        function previewReport() {
            if (verified.length === 0) return showToast('Nessun candidato selezionato');
            
            const html = generateReportHTML();
            document.getElementById('modal-body').innerHTML = `
                <iframe srcdoc="${html.replace(/"/g, '&quot;')}" style="width: 100%; height: 500px; border: none; border-radius: 8px;"></iframe>
            `;
            document.getElementById('modal-overlay').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
        }

        function downloadHTML() {
            if (verified.length === 0) return showToast('Nessun candidato selezionato');
            
            const html = generateReportHTML();
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            downloadBlob(blob, `TITAN_VERITAS_Report_${formatDate()}.html`);
            showToast('Report HTML scaricato');
        }

        function downloadCSV() {
            if (verified.length === 0) return showToast('Nessun candidato selezionato');

            const headers = ['Nome', 'Cognome', 'Categoria', 'Paese', 'Et√†', 'Club', 'Ruolo', 'Score', 'Link'];
            const rows = verified.map(c => [
                c.name, c.surname, c.category, c.country, c.age, c.club, c.position, c.score, c.link
            ]);

            const csv = [headers, ...rows].map(row => 
                row.map(cell => `"${(cell || '').toString().replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
            downloadBlob(blob, `TITAN_VERITAS_Export_${formatDate()}.csv`);
            showToast('CSV scaricato');
        }

        function printReport() {
            const html = generateReportHTML();
            const win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
            setTimeout(() => win.print(), 500);
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function formatDate() {
            return new Date().toISOString().split('T')[0];
        }

        // ==========================================
        // PERSISTENCE
        // ==========================================

        function saveCandidates() {
            localStorage.setItem('titan_v3_candidates', JSON.stringify(candidates));
            updateStats();
        }

        function saveVerified() {
            localStorage.setItem('titan_v3_verified', JSON.stringify(verified));
        }

        // ==========================================
        // UTILS
        // ==========================================

        function updateProgress(current, total, text) {
            const pct = Math.round((current / total) * 100);
            document.getElementById('progress-fill').style.width = `${pct}%`;
            document.getElementById('progress-label').textContent = `${text} (${current}/${total})`;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
