<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITAN VERITAS v3.4 - FSGC Intelligence Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ==========================================
           FSGC OFFICIAL PALETTE
           From fsgc.sm style.css
           ========================================== */
        :root {
            /* FSGC Primary Colors */
            --main-primary: #5EB3E4;
            --main-primary-rgb: 94, 179, 228;
            --main-secondary: #DAA900;
            --main-secondary-rgb: 218, 171, 0;
            --main-tertiary: #9A9B9E;
            --main-dark: #141C32;
            --main-primary-semi: #5EB3E480;
            --main-dark-semi: #141C3280;
            
            /* FSGC UI Colors */
            --primary: #3B68ED;
            --primary-light: #EAEDF7;
            --secondary: #2B4CAD;
            --tertiary: #C4D2FA;
            --badge: #E15560;
            --gray: #ABABAB;
            --gray-light: #DBDBDB;
            
            /* FSGC Semantic Colors */
            --info: #ddeeed;
            --success: #c9f8d7;
            --warning: #ffe4ad;
            --danger: #ffc6c2;
            --info-border: #2b4cad;
            --success-border: #003809;
            --warning-border: #5d3600;
            --danger-border: #7c3130;
            
            /* Bootstrap/FSGC Grays */
            --bs-gray-100: #f8f9fa;
            --bs-gray-200: #e9ecef;
            --bs-gray-300: #dee2e6;
            --bs-gray-400: #ced4da;
            --bs-gray-500: #adb5bd;
            --bs-gray-600: #6c757d;
            --bs-gray-700: #495057;
            --bs-gray-800: #343a40;
            --bs-gray-900: #212529;
            
            /* App-specific mappings */
            --bg-primary: var(--main-dark);
            --bg-secondary: #1a2340;
            --bg-card: #212a45;
            --bg-elevated: #2a3555;
            --accent-primary: var(--main-primary);
            --accent-secondary: var(--secondary);
            --accent-success: #198754;
            --accent-warning: var(--main-secondary);
            --accent-danger: var(--badge);
            --accent-bdfa: var(--main-primary);
            --text-primary: #ffffff;
            --text-secondary: var(--bs-gray-400);
            --text-muted: var(--bs-gray-500);
            --border-primary: #3a4565;
            --border-secondary: #2a3555;
            
            /* FSGC Border Radius */
            --bs-border-radius: 5px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Roboto', system-ui, -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            font-size: 14px;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        /* ==========================================
           MOBILE-FIRST BASE
           ========================================== */
        
        .container {
            width: 100%;
            padding: 12px;
            max-width: 100%;
        }

        /* Header - FSGC Style */
        .header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding: 16px 0;
            border-bottom: 2px solid var(--main-primary);
            margin-bottom: 16px;
            text-align: center;
        }

        .header-left { display: flex; align-items: center; gap: 12px; }

        .logo-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--main-primary) 0%, var(--secondary) 100%);
            border-radius: var(--bs-border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(94, 179, 228, 0.3);
        }

        .logo-text h1 { 
            font-size: 1.125rem; 
            font-weight: 700; 
            letter-spacing: 1px;
            color: var(--main-primary);
        }
        
        .logo-text span { 
            font-size: 0.6875rem; 
            color: var(--text-secondary); 
            font-weight: 400;
        }

        .header-badge {
            background: linear-gradient(135deg, var(--main-secondary) 0%, #c49800 100%);
            color: var(--main-dark);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.6875rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 6px rgba(218, 169, 0, 0.3);
        }

        /* Navigation - FSGC Tab Style */
        .nav {
            display: flex;
            gap: 4px;
            background: var(--bg-secondary);
            padding: 4px;
            border-radius: var(--bs-border-radius);
            margin-bottom: 16px;
            border: 1px solid var(--border-primary);
        }

        .nav-item {
            flex: 1;
            min-width: 60px;
            padding: 10px 8px;
            background: transparent;
            border: none;
            border-radius: var(--bs-border-radius);
            color: var(--text-secondary);
            font-family: 'Roboto', sans-serif;
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .nav-item:hover { 
            color: var(--text-primary); 
            background: var(--bg-elevated); 
        }
        
        .nav-item.active { 
            background: linear-gradient(135deg, var(--main-primary) 0%, var(--secondary) 100%);
            color: #fff;
            box-shadow: 0 2px 8px rgba(94, 179, 228, 0.4);
        }
        
        .nav-icon { font-size: 1.125rem; }
        .nav-label { font-size: 0.625rem; font-weight: 500; }

        /* Panels */
        .panel { display: none; }
        .panel.active { display: block; }

        /* Cards - FSGC Style */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--bs-border-radius);
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .card-header {
            padding: 12px 14px;
            border-bottom: 1px solid var(--border-secondary);
            font-weight: 600;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(90deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            color: var(--main-primary);
        }

        .card-body { padding: 14px; }

        /* Form Elements */
        .form-group { margin-bottom: 14px; }
        
        .form-label { 
            display: block; 
            font-size: 0.75rem; 
            font-weight: 500; 
            color: var(--text-secondary); 
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--bs-border-radius);
            color: var(--text-primary);
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--main-primary);
            box-shadow: 0 0 0 3px rgba(94, 179, 228, 0.2);
        }

        .form-textarea { min-height: 80px; resize: vertical; }
        .form-row { display: flex; flex-direction: column; gap: 12px; }
        .form-hint { font-size: 0.6875rem; color: var(--text-muted); margin-top: 4px; }
        .form-hint a { color: var(--main-primary); }

        /* Buttons - FSGC Style */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 16px;
            border: none;
            border-radius: var(--bs-border-radius);
            font-family: 'Roboto', sans-serif;
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary { 
            background: linear-gradient(135deg, var(--main-primary) 0%, var(--secondary) 100%);
            color: #fff;
            box-shadow: 0 2px 8px rgba(94, 179, 228, 0.3);
        }
        .btn-primary:hover { 
            box-shadow: 0 4px 12px rgba(94, 179, 228, 0.5);
            transform: translateY(-1px);
        }
        
        .btn-secondary { 
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
        }
        .btn-secondary:hover { background: var(--bg-card); }
        
        .btn-success { 
            background: linear-gradient(135deg, var(--accent-success) 0%, #157347 100%);
            color: #fff;
        }
        
        .btn-warning { 
            background: linear-gradient(135deg, var(--main-secondary) 0%, #c49800 100%);
            color: var(--main-dark);
        }
        
        .btn-danger { 
            background: linear-gradient(135deg, var(--accent-danger) 0%, #c44550 100%);
            color: #fff;
        }
        
        .btn-sm { padding: 8px 12px; font-size: 0.75rem; }
        .btn-block { width: 100%; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

        /* Checkbox Grid */
        .checkbox-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: var(--bs-border-radius);
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s ease;
        }

        .checkbox-item:active { background: var(--bg-elevated); }
        .checkbox-item input { margin: 0; width: 18px; height: 18px; accent-color: var(--main-primary); }
        
        .checkbox-item.highlight-fsgc { 
            border-color: var(--main-primary);
            background: rgba(94, 179, 228, 0.1);
        }

        /* Alert - FSGC Style */
        .alert {
            padding: 12px 14px;
            border-radius: var(--bs-border-radius);
            font-size: 0.8125rem;
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            border-left: 4px solid;
        }

        .alert-info { 
            background: var(--info); 
            border-color: var(--info-border); 
            color: var(--main-dark);
        }
        .alert-warning { 
            background: var(--warning); 
            border-color: var(--warning-border); 
            color: var(--main-dark);
        }
        .alert-success { 
            background: var(--success); 
            border-color: var(--success-border); 
            color: var(--main-dark);
        }
        .alert-danger { 
            background: var(--danger); 
            border-color: var(--danger-border); 
            color: var(--main-dark);
        }
        .alert-fsgc { 
            background: rgba(94, 179, 228, 0.15); 
            border-color: var(--main-primary); 
            color: var(--text-primary);
        }
        .alert-icon { font-size: 1rem; flex-shrink: 0; }

        /* Progress - FSGC Gradient */
        .progress-wrapper { margin: 14px 0; }
        .progress-bar { height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden; }
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, var(--main-primary), var(--main-secondary));
            transition: width 0.3s;
            border-radius: 4px;
        }
        .progress-label { 
            font-size: 0.75rem; 
            color: var(--text-secondary); 
            margin-top: 8px; 
            text-align: center;
        }

        /* Stats Grid - FSGC Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 16px; }

        .stat-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--border-primary);
            border-radius: var(--bs-border-radius);
            padding: 14px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--main-primary), var(--main-secondary));
        }

        .stat-value { 
            font-size: 1.75rem; 
            font-weight: 700; 
            color: var(--main-primary);
            font-family: 'Roboto', sans-serif;
        }
        .stat-value.warning { color: var(--main-secondary); }
        .stat-value.success { color: var(--accent-success); }
        .stat-value.danger { color: var(--accent-danger); }
        .stat-value.fsgc { color: var(--main-primary); }
        .stat-label { 
            font-size: 0.625rem; 
            color: var(--text-muted); 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            margin-top: 4px;
            font-weight: 500;
        }

        /* Filter Bar */
        .filter-bar { 
            display: flex; 
            gap: 6px; 
            margin-bottom: 12px; 
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .filter-chip {
            padding: 8px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            flex-shrink: 0;
            font-weight: 500;
        }

        .filter-chip:active { background: var(--bg-elevated); }
        .filter-chip.active { 
            background: linear-gradient(135deg, var(--main-primary) 0%, var(--secondary) 100%);
            border-color: var(--main-primary);
            color: #fff;
            box-shadow: 0 2px 8px rgba(94, 179, 228, 0.3);
        }

        /* Result Cards - FSGC Style */
        .result-card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--bs-border-radius);
            margin-bottom: 10px;
            overflow: hidden;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .result-card:hover { 
            border-color: var(--main-primary);
            box-shadow: 0 4px 12px rgba(94, 179, 228, 0.2);
        }
        
        .result-card.noise { opacity: 0.5; border-color: var(--accent-danger); }
        .result-card.verified { 
            border-color: var(--accent-success);
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(25, 135, 84, 0.1) 100%);
        }
        .result-card.player-profile { border-left: 4px solid var(--accent-success); }
        .result-card.bdfa-source { border-left: 4px solid var(--main-primary); }

        .result-header {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px 14px;
            background: linear-gradient(90deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            border-bottom: 1px solid var(--border-secondary);
        }

        .result-name { font-weight: 600; font-size: 0.9375rem; color: var(--text-primary); }
        .result-badges { display: flex; gap: 6px; flex-wrap: wrap; }

        .badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.625rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-high { 
            background: linear-gradient(135deg, var(--accent-danger) 0%, #c44550 100%);
            color: #fff;
        }
        .badge-medium { 
            background: linear-gradient(135deg, var(--main-secondary) 0%, #c49800 100%);
            color: var(--main-dark);
        }
        .badge-low { 
            background: rgba(25, 135, 84, 0.2);
            color: var(--accent-success);
            border: 1px solid var(--accent-success);
        }
        .badge-noise { 
            background: var(--bg-elevated);
            color: var(--text-muted);
        }
        .badge-verified { 
            background: linear-gradient(135deg, var(--accent-success) 0%, #157347 100%);
            color: #fff;
        }
        .badge-profile { 
            background: rgba(59, 104, 237, 0.2);
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        .badge-bdfa { 
            background: linear-gradient(135deg, var(--main-primary) 0%, var(--secondary) 100%);
            color: #fff;
        }

        .result-body { padding: 12px 14px; }
        .result-meta { display: flex; flex-wrap: wrap; gap: 8px 14px; margin-bottom: 10px; }

        .result-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .result-meta-item .icon { font-size: 0.875rem; }

        .result-snippet {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--bg-secondary);
            padding: 10px 12px;
            border-radius: var(--bs-border-radius);
            margin: 10px 0;
            line-height: 1.6;
            max-height: 80px;
            overflow: hidden;
            border-left: 3px solid var(--main-primary);
        }

        .result-snippet mark {
            background: rgba(218, 169, 0, 0.3);
            color: var(--main-secondary);
            padding: 1px 3px;
            border-radius: 2px;
        }

        .result-link {
            font-family: 'Roboto Mono', monospace;
            font-size: 0.625rem;
            color: var(--main-primary);
            word-break: break-all;
            line-height: 1.4;
        }

        .result-link a { color: inherit; text-decoration: none; }
        .result-link a:hover { text-decoration: underline; }

        .result-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-secondary);
        }

        .result-actions { display: flex; gap: 6px; }

        .result-noise-reason {
            font-size: 0.6875rem;
            color: var(--main-dark);
            padding: 6px 10px;
            background: var(--warning);
            border-radius: var(--bs-border-radius);
            margin-top: 8px;
            border-left: 3px solid var(--warning-border);
        }

        /* Category Tags - FSGC */
        .category-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: var(--bs-border-radius);
            font-size: 0.625rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .category-tag.rare { 
            background: linear-gradient(135deg, var(--accent-danger) 0%, #c44550 100%);
            color: #fff;
        }
        .category-tag.medium { 
            background: linear-gradient(135deg, var(--main-secondary) 0%, #c49800 100%);
            color: var(--main-dark);
        }
        .category-tag.common { 
            background: var(--bg-elevated);
            color: var(--text-muted);
        }

        /* Empty State */
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-state-icon { font-size: 2.5rem; margin-bottom: 12px; opacity: 0.5; }
        .empty-state-title { font-size: 1rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }

        /* Toast - FSGC */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--main-primary);
            padding: 12px 20px;
            border-radius: var(--bs-border-radius);
            font-size: 0.875rem;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
            color: var(--text-primary);
        }

        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* Modal - FSGC */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(20, 28, 50, 0.95);
            z-index: 1000;
            align-items: flex-end;
            padding: 0;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-card);
            border-top: 3px solid var(--main-primary);
            border-radius: 16px 16px 0 0;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(90deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
        }

        .modal-title { font-weight: 600; font-size: 1rem; color: var(--main-primary); }
        .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; }
        .modal-body { padding: 16px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 12px 16px; border-top: 1px solid var(--border-primary); display: flex; gap: 8px; background: var(--bg-secondary); }
        .modal-footer .btn { flex: 1; }

        /* ==========================================
           TABLET (>= 640px)
           ========================================== */
        
        @media (min-width: 640px) {
            .container { padding: 16px; max-width: 720px; margin: 0 auto; }
            .header { flex-direction: row; justify-content: space-between; text-align: left; }
            .nav-item { flex-direction: row; padding: 10px 16px; }
            .nav-label { font-size: 0.8125rem; }
            .checkbox-grid { grid-template-columns: repeat(3, 1fr); }
            .form-row { flex-direction: row; }
            .stats-grid { grid-template-columns: repeat(4, 1fr); }
            .result-header { flex-direction: row; justify-content: space-between; align-items: center; }
            .modal-overlay { align-items: center; padding: 20px; }
            .modal { border-radius: 12px; max-width: 700px; border: 1px solid var(--border-primary); }
        }

        /* ==========================================
           DESKTOP (>= 960px)
           ========================================== */
        
        @media (min-width: 960px) {
            .container { max-width: 960px; padding: 24px; }
            .logo-icon { width: 48px; height: 48px; font-size: 24px; }
            .logo-text h1 { font-size: 1.375rem; }
            .card-body { padding: 18px; }
            .result-snippet { max-height: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-left">
                <div class="logo-icon">ğŸ¯</div>
                <div class="logo-text">
                    <h1>TITAN VERITAS</h1>
                    <span>Heritage Intelligence Platform v3.4</span>
                </div>
            </div>
            <div class="header-badge">FSGC â€¢ RSM</div>
        </header>

        <nav class="nav">
            <button class="nav-item active" data-tab="search"><span class="nav-icon">ğŸ”</span><span class="nav-label">Ricerca</span></button>
            <button class="nav-item" data-tab="results"><span class="nav-icon">ğŸ“Š</span><span class="nav-label">Analisi</span></button>
            <button class="nav-item" data-tab="verified"><span class="nav-icon">âœ“</span><span class="nav-label">Verificati</span></button>
            <button class="nav-item" data-tab="export"><span class="nav-icon">ğŸ“„</span><span class="nav-label">Report</span></button>
        </nav>

        <!-- Search Panel -->
        <div class="panel active" id="panel-search">
            <div class="alert alert-fsgc">
                <span class="alert-icon">ğŸ›ï¸</span>
                <div><strong>v3.4 FSGC Edition</strong> â€” Stile ufficiale Federazione Sammarinese</div>
            </div>

            <div class="card">
                <div class="card-header"><span>ğŸ”‘</span> Configurazione API</div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Serper API Key</label>
                        <input type="password" class="form-input" id="serper-key" placeholder="Inserisci chiave API">
                        <div class="form-hint"><a href="https://serper.dev" target="_blank">serper.dev</a> â€” 2500 ricerche gratuite</div>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="saveApiKey()">Salva</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><span>ğŸ“‹</span> Database Cognomi Sammarinesi</div>
                <div class="card-body">
                    <div class="btn-group" style="margin-bottom: 12px;">
                        <button class="btn btn-sm btn-danger" onclick="loadCognomi('rare')">Rari</button>
                        <button class="btn btn-sm btn-warning" onclick="loadCognomi('medium')">+ Medi</button>
                        <button class="btn btn-sm btn-secondary" onclick="loadCognomi('all')">Tutti</button>
                    </div>
                    <div class="form-group">
                        <textarea class="form-textarea" id="cognomi-input" placeholder="Un cognome per riga..."></textarea>
                    </div>
                    <div id="cognomi-stats"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><span>ğŸŒ</span> Aree Geografiche Target</div>
                <div class="card-body">
                    <div class="checkbox-grid">
                        <label class="checkbox-item highlight-fsgc"><input type="checkbox" name="country" value="Argentina" checked> ğŸ‡¦ğŸ‡· Argentina</label>
                        <label class="checkbox-item"><input type="checkbox" name="country" value="Brazil" checked> ğŸ‡§ğŸ‡· Brasile</label>
                        <label class="checkbox-item"><input type="checkbox" name="country" value="USA" checked> ğŸ‡ºğŸ‡¸ USA</label>
                        <label class="checkbox-item"><input type="checkbox" name="country" value="Uruguay"> ğŸ‡ºğŸ‡¾ Uruguay</label>
                        <label class="checkbox-item"><input type="checkbox" name="country" value="Paraguay"> ğŸ‡µğŸ‡¾ Paraguay</label>
                        <label class="checkbox-item"><input type="checkbox" name="country" value="Chile"> ğŸ‡¨ğŸ‡± Cile</label>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><span>âš™ï¸</span> Parametri Ricerca</div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">EtÃ  Minima</label>
                            <input type="number" class="form-input" id="age-min" value="16" min="14" max="40">
                        </div>
                        <div class="form-group">
                            <label class="form-label">EtÃ  Massima</label>
                            <input type="number" class="form-input" id="age-max" value="28" min="16" max="45">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ProfonditÃ </label>
                            <select class="form-select" id="search-depth">
                                <option value="1">Veloce (1x)</option>
                                <option value="2" selected>Standard (2x)</option>
                                <option value="3">Approfondita (3x)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Risultati</label>
                            <select class="form-select" id="results-num">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="20">20</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-item"><input type="checkbox" id="only-profiles" checked> ğŸ¯ Solo profili giocatore diretti</label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-item highlight-fsgc"><input type="checkbox" id="bdfa-priority" checked> ğŸ‡¦ğŸ‡· PrioritÃ  BDFA Argentina</label>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary btn-block" onclick="startSearch()" id="btn-search">
                ğŸš€ Avvia Ricerca Intelligence
            </button>

            <div class="progress-wrapper" id="progress-wrapper" style="display: none;">
                <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
                <div class="progress-label" id="progress-label">Inizializzazione...</div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="panel" id="panel-results">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="stat-total">0</div><div class="stat-label">Totale</div></div>
                <div class="stat-card"><div class="stat-value success" id="stat-valid">0</div><div class="stat-label">Validi</div></div>
                <div class="stat-card"><div class="stat-value fsgc" id="stat-bdfa">0</div><div class="stat-label">BDFA</div></div>
                <div class="stat-card"><div class="stat-value warning" id="stat-filtered">0</div><div class="stat-label">Filtrati</div></div>
            </div>

            <div class="filter-bar">
                <button class="filter-chip active" data-filter="valid">âœ“ Validi</button>
                <button class="filter-chip" data-filter="bdfa">ğŸ‡¦ğŸ‡· BDFA</button>
                <button class="filter-chip" data-filter="priority">ğŸ”´ Top</button>
                <button class="filter-chip" data-filter="all">ğŸ“¦ Tutti</button>
                <button class="filter-chip" data-filter="filtered">ğŸ—‘ï¸ Filtrati</button>
            </div>

            <button class="btn btn-sm btn-secondary" onclick="clearResults()" style="margin-bottom: 12px;">ğŸ—‘ï¸ Pulisci</button>

            <div id="results-container"></div>
        </div>

        <!-- Verified Panel -->
        <div class="panel" id="panel-verified">
            <div class="alert alert-warning">
                <span class="alert-icon">âš ï¸</span>
                <div>Candidati da sottoporre a verifica anagrafica presso gli uffici RSM</div>
            </div>

            <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="stat-card"><div class="stat-value success" id="stat-verified-count">0</div><div class="stat-label">Selezionati</div></div>
                <div class="stat-card"><div class="stat-value fsgc" id="stat-verified-bdfa">0</div><div class="stat-label">BDFA</div></div>
            </div>

            <div id="verified-container"></div>
        </div>

        <!-- Export Panel -->
        <div class="panel" id="panel-export">
            <div class="card">
                <div class="card-header"><span>ğŸ“„</span> Genera Report FSGC</div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Titolo Documento</label>
                        <input type="text" class="form-input" id="report-title" value="Candidati Oriundi - Analisi Preliminare">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Note Operative</label>
                        <textarea class="form-textarea" id="report-notes" placeholder="Note per il Consiglio Federale..."></textarea>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="previewReport()">ğŸ‘ï¸ Anteprima</button>
                        <button class="btn btn-success" onclick="downloadHTML()">ğŸ“„ HTML</button>
                        <button class="btn btn-secondary" onclick="downloadCSV()">ğŸ“Š CSV</button>
                    </div>
                    <div class="form-hint" style="margin-top: 12px;">
                        ğŸ’¡ Per PDF: Apri HTML â†’ Stampa â†’ Salva come PDF (formato A4)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Anteprima Report</span>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Chiudi</button>
                <button class="btn btn-success" onclick="downloadHTML()">ğŸ“„</button>
                <button class="btn btn-primary" onclick="printReport()">ğŸ–¨ï¸</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ==========================================
        // DATABASE COGNOMI
        // ==========================================
        
        const COGNOMI = {
            rare: ["Gasperoni","Mularoni","Zonzini","Zafferani","Vitaioli","Bacciocchi","Podeschi","Muraccini","Capicchioni","Volpinari","Stolfi","Cioncolini","Tamagnini","Simoncini","Matteoni","Giardi","Ghiotti","Maiani","Raschi","Cevoli"],
            medium: ["Casadei","Zanotti","Guidi","Selva","Benedettini","Stefanelli","Della Valle","Nanni","Valli","Pasolini","Francini","Felici","Ercolani","Michelotti","Renzetti","Salvini","Carchia","Lombardi","Marquisio","Riva","Zoli","Amati","Arlotti","Balducci"],
            common: ["Rossi","Bianchi","Valentini","Ceci","Ferrari","Fabbri","Graziani","Marchetti","Montanari","Rinaldi","Santi"]
        };

        const BLACKLIST = {
            clubsRSM: ["la fiorita","tre penne","tre fiori","folgore","libertas","cosmos","murata","domagnano","faetano","pennarossa","fiorentino","juvenes","dogana","cailungo","san giovanni","virtus acquaviva","san marino academy","san marino calcio"],
            clubsItaly: ["juventus","inter","milan","roma","napoli","lazio","fiorentina","atalanta","torino","bologna","sampdoria","genoa","verona","cesena","pistoiese","rimini","ravenna","reggiana","modena","parma","brescia","como","cremonese","spal","vicenza"],
            leagues: ["serie a","serie b","serie c","serie d","lega pro","eccellenza","promozione","campionato sammarinese"],
            roles: ["manager","coach","allenatore","director","presidente","staff","scout","agent","agente","retired","ritirato","ex-"],
            famousPlayers: ["messi","ronaldo","neymar","mbappe","de bruyne","iniesta"],
            urlBlacklist: ["/verein/","/startseite/verein/","saison_id","/squad/","spielegegeneinander","gegner","opponents","marktwerte","transfers","berateruebersicht","/news/","/statistik/","/staff/"],
            urlWhitelist: ["/spieler/","/profil/","/player/","/jugador/","/jogador/","bdfa.com.ar/jugadores"],
            italianIndicators: ["italy,","italia,","italiano",", italy","nato in italia","born in italy","cesena,","pistoiese,","rimini,","serie a","serie b"]
        };

        let candidates = JSON.parse(localStorage.getItem('titan_v34_candidates') || '[]');
        let verified = JSON.parse(localStorage.getItem('titan_v34_verified') || '[]');
        let currentFilter = 'valid';

        // ==========================================
        // INIT
        // ==========================================

        document.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('serper_api_key');
            if (savedKey) document.getElementById('serper-key').value = savedKey;
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => switchTab(item.dataset.tab));
            });

            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentFilter = chip.dataset.filter;
                    renderResults();
                });
            });

            document.getElementById('cognomi-input').addEventListener('input', updateCognomiStats);
            updateStats();
        });

        function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`.nav-item[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`panel-${tabId}`).classList.add('active');
            if (tabId === 'results') renderResults();
            if (tabId === 'verified') renderVerified();
        }

        // ==========================================
        // COGNOMI
        // ==========================================

        function loadCognomi(level) {
            let list = level === 'rare' ? COGNOMI.rare : level === 'medium' ? [...COGNOMI.rare, ...COGNOMI.medium] : [...COGNOMI.rare, ...COGNOMI.medium, ...COGNOMI.common];
            document.getElementById('cognomi-input').value = list.join('\n');
            updateCognomiStats();
            showToast(`${list.length} cognomi caricati`);
        }

        function getCognomi() { return document.getElementById('cognomi-input').value.split('\n').map(c => c.trim()).filter(c => c.length > 0); }

        function getCognomeCategory(cognome) {
            const c = cognome.toLowerCase();
            if (COGNOMI.rare.map(x => x.toLowerCase()).includes(c)) return 'rare';
            if (COGNOMI.medium.map(x => x.toLowerCase()).includes(c)) return 'medium';
            return 'common';
        }

        function updateCognomiStats() {
            const cognomi = getCognomi();
            const stats = document.getElementById('cognomi-stats');
            if (cognomi.length === 0) { stats.innerHTML = ''; return; }
            const rare = cognomi.filter(c => getCognomeCategory(c) === 'rare').length;
            const medium = cognomi.filter(c => getCognomeCategory(c) === 'medium').length;
            stats.innerHTML = `<div style="display:flex;gap:8px;font-size:0.75rem;flex-wrap:wrap;"><span class="category-tag rare">R: ${rare}</span><span class="category-tag medium">M: ${medium}</span><span style="color:var(--text-muted)">Totale: ${cognomi.length}</span></div>`;
        }

        function saveApiKey() { const key = document.getElementById('serper-key').value.trim(); if (key) { localStorage.setItem('serper_api_key', key); showToast('Chiave salvata'); } }

        // ==========================================
        // SEARCH
        // ==========================================

        async function startSearch() {
            const apiKey = document.getElementById('serper-key').value.trim() || localStorage.getItem('serper_api_key');
            if (!apiKey) return showToast('API Key mancante');
            const cognomi = getCognomi();
            if (cognomi.length === 0) return showToast('Carica cognomi');
            const countries = Array.from(document.querySelectorAll('input[name="country"]:checked')).map(c => c.value);
            if (countries.length === 0) return showToast('Seleziona paesi');

            const ageMin = parseInt(document.getElementById('age-min').value) || 16;
            const ageMax = parseInt(document.getElementById('age-max').value) || 28;
            const depth = parseInt(document.getElementById('search-depth').value);
            const resultsNum = parseInt(document.getElementById('results-num').value);
            const onlyProfiles = document.getElementById('only-profiles').checked;
            const bdfaPriority = document.getElementById('bdfa-priority').checked;

            document.getElementById('btn-search').disabled = true;
            document.getElementById('progress-wrapper').style.display = 'block';

            let totalSearches = 0;
            for (const cognome of cognomi) {
                for (const country of countries) {
                    totalSearches += depth;
                    if (bdfaPriority && country === 'Argentina') totalSearches += 2;
                }
            }

            let completed = 0, newCandidates = 0;

            for (const cognome of cognomi) {
                if (bdfaPriority && countries.includes('Argentina')) {
                    for (const query of [`site:bdfa.com.ar/jugadores "${cognome}"`, `site:bdfa.com.ar "${cognome}" nacionalidad argentina`]) {
                        try {
                            updateProgress(completed, totalSearches, `BDFA: ${cognome}`);
                            const results = await searchSerper(apiKey, query, resultsNum);
                            newCandidates += processResults(results, cognome, 'Argentina', ageMin, ageMax, onlyProfiles, true);
                            completed++;
                            await sleep(400);
                        } catch (err) { completed++; }
                    }
                }

                for (const country of countries) {
                    const queries = buildQueries(cognome, country, depth);
                    for (const query of queries) {
                        try {
                            updateProgress(completed, totalSearches, `${cognome} (${country})`);
                            const results = await searchSerper(apiKey, query, resultsNum);
                            newCandidates += processResults(results, cognome, country, ageMin, ageMax, onlyProfiles, false);
                            completed++;
                            await sleep(350);
                        } catch (err) { completed++; }
                    }
                }
            }

            document.getElementById('btn-search').disabled = false;
            document.getElementById('progress-wrapper').style.display = 'none';
            saveCandidates();
            showToast(`+${newCandidates} candidati trovati`);
            switchTab('results');
        }

        function buildQueries(cognome, country, depth) {
            const queries = [];
            if (country === 'Argentina') {
                queries.push(`site:transfermarkt.com/*/spieler/ "${cognome}" argentina`);
                if (depth >= 2) queries.push(`"${cognome}" futbolista argentino perfil -italy -italia -serie`);
                if (depth >= 3) queries.push(`site:soccerway.com/players/ "${cognome}" argentina`);
            } else if (country === 'Brazil') {
                queries.push(`site:transfermarkt.com/*/spieler/ "${cognome}" brazil brasileiro`);
                if (depth >= 2) queries.push(`site:ogol.com.br/jogador "${cognome}"`);
                if (depth >= 3) queries.push(`"${cognome}" jogador brasileiro perfil -italy -italia`);
            } else if (country === 'USA') {
                queries.push(`site:transfermarkt.com/*/spieler/ "${cognome}" usa american mls`);
                if (depth >= 2) queries.push(`"${cognome}" soccer player american profile mls -italy`);
                if (depth >= 3) queries.push(`site:soccerway.com/players/ "${cognome}" usa`);
            } else {
                queries.push(`site:transfermarkt.com/*/spieler/ "${cognome}" ${country}`);
                if (depth >= 2) queries.push(`"${cognome}" footballer ${country} profile -italy -italia`);
            }
            return queries.slice(0, depth);
        }

        async function searchSerper(apiKey, query, num) {
            const response = await fetch('https://google.serper.dev/search', {
                method: 'POST',
                headers: { 'X-API-KEY': apiKey, 'Content-Type': 'application/json' },
                body: JSON.stringify({ q: query, num: num })
            });
            if (!response.ok) throw new Error(`API error: ${response.status}`);
            return (await response.json()).organic || [];
        }

        function processResults(results, cognome, country, ageMin, ageMax, onlyProfiles, isBDFASearch) {
            let added = 0;
            for (const result of results) {
                const analyzed = analyzeResult(result, cognome, country, ageMin, ageMax, onlyProfiles, isBDFASearch);
                if (!candidates.some(c => c.link === analyzed.link || (c.name === analyzed.name && c.surname === analyzed.surname && c.country === analyzed.country))) {
                    candidates.push(analyzed);
                    added++;
                }
            }
            return added;
        }

        function analyzeResult(result, cognome, searchCountry, ageMin, ageMax, onlyProfiles, isBDFASearch) {
            const title = result.title || '', snippet = result.snippet || '', link = result.link || '';
            const fullText = `${title} ${snippet}`.toLowerCase(), linkLower = link.toLowerCase();
            const noiseReasons = [];
            let isPlayerProfile = false, isBDFA = linkLower.includes('bdfa.com.ar');

            for (const p of BLACKLIST.urlWhitelist) if (linkLower.includes(p)) { isPlayerProfile = true; break; }
            if (isBDFA && linkLower.includes('/jugadores')) isPlayerProfile = true;
            for (const p of BLACKLIST.urlBlacklist) if (linkLower.includes(p)) { noiseReasons.push('URL non valido'); isPlayerProfile = false; break; }
            for (const c of BLACKLIST.clubsRSM) if (fullText.includes(c)) { noiseReasons.push('Club RSM'); break; }
            for (const c of BLACKLIST.clubsItaly) if (linkLower.includes(c)) { noiseReasons.push('Club italiano'); break; }
            for (const l of BLACKLIST.leagues) if (fullText.includes(l)) { noiseReasons.push('Lega esclusa'); break; }
            for (const r of BLACKLIST.roles) if (fullText.includes(r)) { noiseReasons.push('Non giocatore'); break; }
            for (const p of BLACKLIST.famousPlayers) if (title.toLowerCase().includes(p)) { noiseReasons.push('Famoso'); break; }
            if (!isBDFA) for (const i of BLACKLIST.italianIndicators) if (fullText.includes(i)) { noiseReasons.push('Italiano'); break; }
            if (!fullText.includes(cognome.toLowerCase())) noiseReasons.push('Cognome assente');
            if (onlyProfiles && !isPlayerProfile && noiseReasons.length === 0) noiseReasons.push('Non profilo');

            let playerName, detectedCountry, age, club, position;
            if (isBDFA) {
                const d = parseBDFA(title, snippet, link, cognome);
                playerName = d.name; detectedCountry = d.country; age = d.age; club = d.club; position = d.position;
            } else {
                playerName = extractName(title, snippet, cognome);
                detectedCountry = detectCountry(fullText, searchCountry);
                age = extractAge(snippet, title);
                club = extractClub(snippet);
                position = extractPosition(fullText);
            }

            if (age) { const a = parseInt(age); if (a < ageMin) noiseReasons.push(`<${ageMin}`); if (a > ageMax) noiseReasons.push(`>${ageMax}`); }

            const category = getCognomeCategory(cognome);
            let score = category === 'rare' ? 4 : category === 'medium' ? 2 : 1;
            if (['Argentina','Brazil','USA'].includes(detectedCountry)) score += 2;
            if (noiseReasons.length === 0) score += 3;
            if (isPlayerProfile) score += 3;
            if (isBDFA) score += 4;
            if (age && parseInt(age) >= 18 && parseInt(age) <= 25) score += 1;
            if (position) score += 1;

            return { id: Date.now() + Math.random(), name: playerName, surname: cognome, category, country: detectedCountry, age, club, position, score, isNoise: noiseReasons.length > 0, isPlayerProfile, isBDFA, noiseReasons, title, snippet, link, addedAt: new Date().toISOString() };
        }

        function parseBDFA(title, snippet, link, cognome) {
            let name = '', country = 'Argentina', age = '', club = '', position = '';
            const urlMatch = link.match(/jugadores-([A-Z\-]+)-\d+\.html/i);
            if (urlMatch) name = urlMatch[1].replace(/-/g, ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
            else { const p = title.split('|'); if (p.length > 0) name = p[0].trim(); }
            const posMatch = title.match(/\|\s*(Arquero|Defensor|Mediocampista|Delantero|Lateral|Volante)/i) || snippet.match(/PosiciÃ³n:\s*(Arquero|Defensor|Mediocampista|Delantero|Lateral|Volante)/i);
            if (posMatch) { const m = { arquero:'Portiere', defensor:'Difensore', lateral:'Terzino', mediocampista:'Centrocampista', volante:'Mediano', delantero:'Attaccante' }; position = m[posMatch[1].toLowerCase()] || posMatch[1]; }
            const ageMatch = snippet.match(/\((\d{1,2})\s*aÃ±os?\)/i);
            if (ageMatch) age = ageMatch[1]; else { const b = snippet.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/); if (b) age = (new Date().getFullYear() - parseInt(b[3])).toString(); }
            const clubMatch = snippet.match(/Club:\s*([^\.]+)/i); if (clubMatch) club = clubMatch[1].trim().substring(0, 25);
            return { name, country, age, club, position };
        }

        function extractName(title, snippet, cognome) {
            for (const regex of [new RegExp(`([A-Z][a-zÃ -Ã¿]+)\\s+${cognome}`, 'i'), new RegExp(`${cognome},?\\s+([A-Z][a-zÃ -Ã¿]+)`, 'i')]) {
                const m = title.match(regex) || snippet.match(regex);
                if (m) return `${m[1]} ${cognome}`;
            }
            const clean = title.split(' - ')[0].split(' | ')[0].trim();
            if (clean.length < 35 && clean.toLowerCase().includes(cognome.toLowerCase())) return clean;
            return `[?] ${cognome}`;
        }

        function detectCountry(text, fallback) {
            const p = { Argentina:['argentina','argentino'], Brazil:['brazil','brasil','brasileiro'], USA:['usa','united states','american','mls'], Uruguay:['uruguay','uruguayo'], Paraguay:['paraguay','paraguayo'], Chile:['chile','chileno'] };
            for (const [c, terms] of Object.entries(p)) for (const t of terms) if (text.includes(t)) return c;
            return fallback;
        }

        function extractAge(snippet, title) {
            const combined = `${snippet} ${title}`;
            for (const p of [/\((\d{1,2})\s*aÃ±os?\)/i, /\((\d{1,2})\s*years?\)/i, /age[:\s]*(\d{1,2})/i, /(\d{1,2})\s*anni/i]) {
                const m = combined.match(p);
                if (m && parseInt(m[1]) >= 14 && parseInt(m[1]) <= 50) return m[1];
            }
            const y = combined.match(/\b(19[89]\d|200\d|201\d)\b/);
            if (y) { const a = new Date().getFullYear() - parseInt(y[1]); if (a >= 14 && a <= 50) return a.toString(); }
            return '';
        }

        function extractClub(snippet) { const m = snippet.match(/(?:club|plays? for)[:\s]*([A-Za-zÃ€-Ã¿\s]+?)(?:\.|,|;|$)/i); return m ? m[1].trim().substring(0, 25) : ''; }

        function extractPosition(text) {
            const p = { goalkeeper:'Portiere', portiere:'Portiere', arquero:'Portiere', defender:'Difensore', difensore:'Difensore', defensor:'Difensore', midfielder:'Centrocampista', mediocampista:'Centrocampista', forward:'Attaccante', delantero:'Attaccante', striker:'Punta' };
            const t = text.toLowerCase();
            for (const [k, v] of Object.entries(p)) if (t.includes(k)) return v;
            return '';
        }

        // ==========================================
        // RENDERING
        // ==========================================

        function renderResults() {
            updateStats();
            const container = document.getElementById('results-container');
            let filtered = candidates;
            switch (currentFilter) {
                case 'valid': filtered = candidates.filter(c => !c.isNoise); break;
                case 'bdfa': filtered = candidates.filter(c => !c.isNoise && c.isBDFA); break;
                case 'priority': filtered = candidates.filter(c => !c.isNoise && c.score >= 10); break;
                case 'filtered': filtered = candidates.filter(c => c.isNoise); break;
            }
            if (filtered.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><div class="empty-state-title">Nessun risultato</div></div>'; return; }
            filtered.sort((a, b) => b.score - a.score);
            container.innerHTML = filtered.map(c => renderCard(c)).join('');
        }

        function renderCard(c) {
            const badgeClass = c.isNoise ? 'badge-noise' : c.score >= 10 ? 'badge-high' : c.score >= 6 ? 'badge-medium' : 'badge-low';
            const badgeText = c.isNoise ? 'FILTRATO' : c.score >= 10 ? 'PRIORITÃ€' : c.score >= 6 ? 'MEDIO' : 'BASSO';
            const isV = verified.some(v => v.id === c.id);
            return `<div class="result-card ${c.isNoise ? 'noise' : ''} ${isV ? 'verified' : ''} ${c.isBDFA ? 'bdfa-source' : c.isPlayerProfile ? 'player-profile' : ''}">
                <div class="result-header">
                    <span class="result-name">${c.name}</span>
                    <div class="result-badges">${c.isBDFA ? '<span class="badge badge-bdfa">BDFA</span>' : ''}${isV ? '<span class="badge badge-verified">âœ“</span>' : ''}<span class="badge ${badgeClass}">${badgeText}</span></div>
                </div>
                <div class="result-body">
                    <div class="result-meta">
                        <span class="category-tag ${c.category}">${c.surname}</span>
                        ${c.country ? `<span class="result-meta-item">ğŸŒ ${c.country}</span>` : ''}
                        ${c.age ? `<span class="result-meta-item">ğŸ“… ${c.age}</span>` : ''}
                        ${c.position ? `<span class="result-meta-item">ğŸ‘¤ ${c.position}</span>` : ''}
                        <span class="result-meta-item">â­ ${c.score}</span>
                    </div>
                    <div class="result-snippet">${c.snippet.replace(new RegExp(`(${c.surname})`, 'gi'), '<mark>$1</mark>')}</div>
                    ${c.isNoise ? `<div class="result-noise-reason">${c.noiseReasons.join(' â€¢ ')}</div>` : ''}
                    <div class="result-link"><a href="${c.link}" target="_blank">${c.link}</a></div>
                </div>
                <div class="result-footer">
                    <div class="result-actions">
                        ${!c.isNoise ? `<button class="btn btn-sm ${isV ? 'btn-success' : 'btn-secondary'}" onclick="toggleVerify(${c.id})">${isV ? 'âœ“' : 'â˜'}</button>` : `<button class="btn btn-sm btn-secondary" onclick="restore(${c.id})">â™»ï¸</button>`}
                        <button class="btn btn-sm btn-danger" onclick="remove(${c.id})">ğŸ—‘ï¸</button>
                    </div>
                </div>
            </div>`;
        }

        function renderVerified() {
            updateVerifiedStats();
            const container = document.getElementById('verified-container');
            if (verified.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><div class="empty-state-title">Nessun candidato</div></div>'; return; }
            container.innerHTML = verified.map(c => `<div class="result-card verified ${c.isBDFA ? 'bdfa-source' : ''}">
                <div class="result-header"><span class="result-name">${c.name}</span><div class="result-badges">${c.isBDFA ? '<span class="badge badge-bdfa">BDFA</span>' : ''}<span class="category-tag ${c.category}">${c.surname}</span></div></div>
                <div class="result-body">
                    <div class="result-meta">${c.country ? `<span>ğŸŒ ${c.country}</span>` : ''}${c.age ? `<span>ğŸ“… ${c.age}</span>` : ''}${c.position ? `<span>ğŸ‘¤ ${c.position}</span>` : ''}</div>
                    <div class="result-link"><a href="${c.link}" target="_blank">${c.link}</a></div>
                </div>
                <div class="result-footer"><button class="btn btn-sm btn-danger" onclick="removeV(${c.id})">âŒ</button></div>
            </div>`).join('');
        }

        // ==========================================
        // ACTIONS
        // ==========================================

        function toggleVerify(id) {
            const c = candidates.find(x => x.id === id);
            if (!c) return;
            const idx = verified.findIndex(v => v.id === id);
            if (idx >= 0) verified.splice(idx, 1); else verified.push(c);
            saveVerified(); renderResults();
        }

        function restore(id) { const c = candidates.find(x => x.id === id); if (c) { c.isNoise = false; c.noiseReasons = []; saveCandidates(); renderResults(); } }
        function remove(id) { candidates = candidates.filter(c => c.id !== id); verified = verified.filter(v => v.id !== id); saveCandidates(); saveVerified(); renderResults(); }
        function removeV(id) { verified = verified.filter(v => v.id !== id); saveVerified(); renderVerified(); }
        function clearResults() { if (confirm('Eliminare tutti i risultati?')) { candidates = []; verified = []; saveCandidates(); saveVerified(); renderResults(); } }

        // ==========================================
        // STATS
        // ==========================================

        function updateStats() {
            const valid = candidates.filter(c => !c.isNoise), bdfa = valid.filter(c => c.isBDFA);
            document.getElementById('stat-total').textContent = candidates.length;
            document.getElementById('stat-valid').textContent = valid.length;
            document.getElementById('stat-bdfa').textContent = bdfa.length;
            document.getElementById('stat-filtered').textContent = candidates.filter(c => c.isNoise).length;
        }

        function updateVerifiedStats() {
            document.getElementById('stat-verified-count').textContent = verified.length;
            document.getElementById('stat-verified-bdfa').textContent = verified.filter(c => c.isBDFA).length;
        }

        // ==========================================
        // EXPORT - FSGC OFFICIAL STYLE A4
        // ==========================================

        function generateReportHTML() {
            const title = document.getElementById('report-title').value || 'Candidati Oriundi';
            const notes = document.getElementById('report-notes').value;
            const date = new Date().toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric' });
            const bdfaCount = verified.filter(c => c.isBDFA).length;

            return `<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>${title} - FSGC</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* FSGC Official Print Styles */
        @page {
            size: A4;
            margin: 18mm 15mm 22mm 15mm;
        }
        
        @media print {
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .no-break { page-break-inside: avoid; break-inside: avoid; }
        }

        :root {
            --main-primary: #5EB3E4;
            --main-secondary: #DAA900;
            --main-dark: #141C32;
            --primary: #3B68ED;
            --secondary: #2B4CAD;
            --warning: #ffe4ad;
            --warning-border: #5d3600;
            --info: #ddeeed;
            --info-border: #2b4cad;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Roboto', -apple-system, sans-serif;
            background: #fff;
            color: var(--main-dark);
            font-size: 10pt;
            line-height: 1.45;
        }
        
        .report {
            max-width: 180mm;
            margin: 0 auto;
        }
        
        /* Header - FSGC Style */
        .header {
            text-align: center;
            padding-bottom: 14pt;
            border-bottom: 3pt solid var(--main-primary);
            margin-bottom: 14pt;
        }
        
        .logo-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12pt;
            margin-bottom: 10pt;
        }
        
        .fsgc-badge {
            background: linear-gradient(135deg, var(--main-secondary) 0%, #c49800 100%);
            color: var(--main-dark);
            padding: 4pt 12pt;
            border-radius: 12pt;
            font-size: 7pt;
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        .logo-text { font-size: 9pt; color: #666; letter-spacing: 2px; font-weight: 500; }
        .title { font-size: 18pt; font-weight: 700; color: var(--main-dark); margin-bottom: 4pt; }
        .subtitle { font-size: 9pt; color: #666; }
        
        .watermark {
            display: inline-block;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: #fff;
            padding: 5pt 14pt;
            border-radius: 4pt;
            font-size: 7pt;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-top: 10pt;
        }
        
        /* Alerts */
        .disclaimer {
            background: var(--warning);
            border-left: 4pt solid var(--warning-border);
            color: var(--main-dark);
            padding: 10pt 12pt;
            margin-bottom: 14pt;
            font-size: 8pt;
            border-radius: 0 4pt 4pt 0;
        }
        
        .notes {
            background: var(--info);
            border-left: 4pt solid var(--info-border);
            color: var(--main-dark);
            padding: 10pt 12pt;
            margin-bottom: 14pt;
            font-size: 8pt;
            border-radius: 0 4pt 4pt 0;
        }
        
        /* Stats */
        .stats {
            display: flex;
            gap: 10pt;
            margin-bottom: 14pt;
        }
        
        .stat {
            flex: 1;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 10pt;
            border-radius: 4pt;
            text-align: center;
            border-top: 3pt solid var(--main-primary);
        }
        
        .stat-value { font-size: 16pt; font-weight: 700; color: var(--main-primary); }
        .stat-value.gold { color: var(--main-secondary); }
        .stat-label { font-size: 7pt; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2pt; }
        
        /* Section */
        .section-title {
            font-size: 11pt;
            font-weight: 600;
            margin-bottom: 10pt;
            padding-bottom: 6pt;
            border-bottom: 2pt solid var(--main-primary);
            color: var(--main-dark);
        }
        
        /* Candidate Card */
        .candidate {
            border: 1pt solid #dee2e6;
            border-radius: 4pt;
            margin-bottom: 10pt;
            page-break-inside: avoid;
            break-inside: avoid;
            overflow: hidden;
        }
        
        .candidate.bdfa { border-left: 4pt solid var(--main-primary); }
        
        .candidate-header {
            background: linear-gradient(90deg, #f8f9fa 0%, #fff 100%);
            padding: 8pt 12pt;
            border-bottom: 1pt solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .candidate-name { font-weight: 600; font-size: 10pt; color: var(--main-dark); }
        
        .candidate-badge {
            background: linear-gradient(135deg, var(--main-primary) 0%, var(--secondary) 100%);
            color: #fff;
            padding: 3pt 10pt;
            border-radius: 10pt;
            font-size: 6pt;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        
        .candidate-badge.gold {
            background: linear-gradient(135deg, var(--main-secondary) 0%, #c49800 100%);
            color: var(--main-dark);
        }
        
        .candidate-body { padding: 10pt 12pt; }
        
        .candidate-meta {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8pt;
            margin-bottom: 8pt;
        }
        
        .meta-label { color: #666; font-size: 6pt; text-transform: uppercase; letter-spacing: 0.3px; }
        .meta-value { font-size: 9pt; font-weight: 500; }
        
        .candidate-link {
            font-size: 7pt;
            color: var(--primary);
            word-break: break-all;
            margin-top: 6pt;
            padding-top: 6pt;
            border-top: 1pt solid #e9ecef;
        }
        
        /* Footer */
        .footer {
            margin-top: 18pt;
            padding-top: 10pt;
            border-top: 2pt solid var(--main-primary);
            text-align: center;
            font-size: 7pt;
            color: #666;
        }
        
        .footer-fsgc { 
            color: var(--main-primary);
            font-weight: 600;
            margin-bottom: 4pt;
        }
        
        .footer-watermark { 
            color: #dc3545;
            font-weight: 600;
            margin-top: 6pt;
            font-size: 8pt;
        }
    </style>
</head>
<body>
    <div class="report">
        <div class="header">
            <div class="logo-row">
                <span class="fsgc-badge">FSGC</span>
                <span class="logo-text">TITAN VERITAS v3.4 â€¢ HERITAGE INTELLIGENCE</span>
            </div>
            <h1 class="title">${title}</h1>
            <div class="subtitle">Generato il ${date} â€¢ ${verified.length} candidati identificati</div>
            <div class="watermark">âš  DOCUMENTO RISERVATO â€” VERIFICA ANAGRAFICA RICHIESTA</div>
        </div>

        <div class="disclaimer">
            <strong>AVVERTENZA:</strong> Il presente documento contiene dati preliminari raccolti da fonti pubbliche (BDFA, Transfermarkt, Soccerway). 
            Le informazioni richiedono <strong>verifica ufficiale</strong> presso l'Ufficio Anagrafe della Repubblica di San Marino per confermare l'eleggibilitÃ .
        </div>

        ${notes ? `<div class="notes"><strong>Note operative:</strong> ${notes}</div>` : ''}

        <div class="stats">
            <div class="stat">
                <div class="stat-value">${verified.length}</div>
                <div class="stat-label">Candidati Totali</div>
            </div>
            <div class="stat">
                <div class="stat-value gold">${bdfaCount}</div>
                <div class="stat-label">Da BDFA Argentina</div>
            </div>
        </div>

        <div class="section-title">ğŸ“‹ Elenco Candidati per Verifica Anagrafica</div>

        ${verified.map((c, i) => `
            <div class="candidate no-break ${c.isBDFA ? 'bdfa' : ''}">
                <div class="candidate-header">
                    <span class="candidate-name">${i + 1}. ${c.name}</span>
                    <span class="candidate-badge ${c.isBDFA ? '' : 'gold'}">${c.isBDFA ? 'ğŸ‡¦ğŸ‡· BDFA ARGENTINA' : c.category.toUpperCase()}</span>
                </div>
                <div class="candidate-body">
                    <div class="candidate-meta">
                        <div><div class="meta-label">Cognome</div><div class="meta-value">${c.surname}</div></div>
                        <div><div class="meta-label">NazionalitÃ </div><div class="meta-value">${c.country || 'Da verificare'}</div></div>
                        <div><div class="meta-label">EtÃ </div><div class="meta-value">${c.age ? c.age + ' anni' : 'Da verificare'}</div></div>
                        <div><div class="meta-label">Club Attuale</div><div class="meta-value">${c.club || 'Da verificare'}</div></div>
                        <div><div class="meta-label">Ruolo</div><div class="meta-value">${c.position || 'Da verificare'}</div></div>
                        <div><div class="meta-label">Score</div><div class="meta-value">${c.score}/15</div></div>
                    </div>
                    <div class="candidate-link">ğŸ”— Fonte: ${c.link}</div>
                </div>
            </div>
        `).join('')}

        <div class="footer">
            <div class="footer-fsgc">FEDERAZIONE SAMMARINESE GIUOCO CALCIO</div>
            <div>Report generato da TITAN VERITAS Intelligence Platform v3.4</div>
            <div>Documento ad uso interno â€” Non divulgare</div>
            <div class="footer-watermark">âš  RISERVATO â€” VERIFICA ANAGRAFICA RSM OBBLIGATORIA</div>
        </div>
    </div>
</body>
</html>`;
        }

        function previewReport() {
            if (verified.length === 0) return showToast('Nessun candidato');
            document.getElementById('modal-body').innerHTML = `<iframe srcdoc="${generateReportHTML().replace(/"/g, '&quot;')}" style="width:100%;height:100%;min-height:400px;border:none;border-radius:4px;background:#fff;"></iframe>`;
            document.getElementById('modal-overlay').classList.add('active');
        }

        function closeModal() { document.getElementById('modal-overlay').classList.remove('active'); }

        function downloadHTML() {
            if (verified.length === 0) return showToast('Nessun candidato');
            const blob = new Blob([generateReportHTML()], { type: 'text/html;charset=utf-8' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `FSGC_TITAN_Report_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            showToast('Report FSGC scaricato');
        }

        function downloadCSV() {
            if (verified.length === 0) return showToast('Nessun candidato');
            const h = ['#','Nome','Cognome','Categoria','Paese','EtÃ ','Club','Ruolo','Score','BDFA','Fonte'];
            const r = verified.map((c,i) => [i+1,c.name,c.surname,c.category,c.country,c.age,c.club,c.position,c.score,c.isBDFA?'SÃ¬':'No',c.link]);
            const csv = [h,...r].map(row => row.map(c => `"${(c||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
            const blob = new Blob(['\ufeff'+csv], { type: 'text/csv;charset=utf-8' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `FSGC_TITAN_Export_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            showToast('CSV esportato');
        }

        function printReport() {
            const win = window.open('', '_blank');
            win.document.write(generateReportHTML());
            win.document.close();
            setTimeout(() => win.print(), 500);
        }

        // ==========================================
        // PERSISTENCE & UTILS
        // ==========================================

        function saveCandidates() { localStorage.setItem('titan_v34_candidates', JSON.stringify(candidates)); updateStats(); }
        function saveVerified() { localStorage.setItem('titan_v34_verified', JSON.stringify(verified)); }

        function updateProgress(current, total, text) {
            document.getElementById('progress-fill').style.width = `${Math.round((current/total)*100)}%`;
            document.getElementById('progress-label').textContent = `${text} (${current}/${total})`;
        }

        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }
    </script>
</body>
</html>
