<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITAN VERITAS - Oriundi Scanner</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --accent-gold: #d4af37;
            --accent-gold-dim: #b8960c;
            --accent-blue: #4a9eff;
            --accent-green: #22c55e;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
            --text-primary: #f0f0f0;
            --text-secondary: #888;
            --border: #2a2a3a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            background-image: 
                radial-gradient(ellipse at 20% 20%, rgba(212, 175, 55, 0.03) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(74, 158, 255, 0.03) 0%, transparent 50%);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-dim) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 4px;
            margin-bottom: 8px;
        }

        .tagline {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
            letter-spacing: 2px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .tab {
            flex: 1;
            padding: 15px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .tab:hover {
            border-color: var(--accent-gold-dim);
        }

        .tab.active {
            border-color: var(--accent-gold);
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, transparent 100%);
        }

        .tab-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .tab-label {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .tab-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 3px;
        }

        /* Panels */
        .panel {
            display: none;
        }

        .panel.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Form Elements */
        label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-dim) 100%);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.3);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--accent-gold);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Checkbox group */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .checkbox-item:hover {
            background: var(--bg-card);
        }

        .checkbox-item input {
            width: auto;
            margin: 0;
        }

        /* Query Box */
        .query-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            word-break: break-all;
        }

        .query-box.clickable {
            cursor: pointer;
            transition: all 0.2s;
        }

        .query-box.clickable:hover {
            border-color: var(--accent-blue);
            background: rgba(74, 158, 255, 0.05);
        }

        /* Results */
        .results-container {
            margin-top: 20px;
        }

        .result-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .result-item:hover {
            border-color: var(--accent-gold-dim);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .result-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .result-score {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .score-high {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }

        .score-medium {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-orange);
            border: 1px solid var(--accent-orange);
        }

        .score-low {
            background: rgba(34, 197, 94, 0.2);
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }

        .result-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .result-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .result-source {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--accent-blue);
            word-break: break-all;
        }

        .result-source a {
            color: var(--accent-blue);
            text-decoration: none;
        }

        .result-source a:hover {
            text-decoration: underline;
        }

        /* Stats */
        .stats-bar {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-gold);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Progress */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-gold), var(--accent-blue));
            border-radius: 3px;
            transition: width 0.3s;
        }

        /* Cognomi List */
        .cognomi-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            max-height: 150px;
            overflow-y: auto;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .cognome-tag {
            padding: 4px 10px;
            background: var(--bg-card);
            border-radius: 4px;
            font-size: 0.8rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .cognome-tag.rare {
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
        }

        .cognome-tag.medium {
            border: 1px solid var(--accent-orange);
            color: var(--accent-orange);
        }

        .cognome-tag.common {
            border: 1px solid var(--text-secondary);
            color: var(--text-secondary);
        }

        /* Mobile */
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }

            .logo {
                font-size: 1.8rem;
            }

            .tabs {
                flex-direction: column;
            }

            .checkbox-group {
                grid-template-columns: repeat(2, 1fr);
            }

            .btn-row {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            border: 1px solid var(--accent-gold);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.9rem;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Export */
        .export-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">TITAN VERITAS</div>
            <div class="tagline">ORIUNDI SCANNER ‚Ä¢ RSM HERITAGE FINDER</div>
        </header>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="manual">
                <div class="tab-icon">üîç</div>
                <div class="tab-label">Manuale</div>
                <div class="tab-desc">Genera query, cerca tu</div>
            </div>
            <div class="tab" data-tab="auto">
                <div class="tab-icon">‚ö°</div>
                <div class="tab-label">Automatico</div>
                <div class="tab-desc">Con Serper API</div>
            </div>
            <div class="tab" data-tab="results">
                <div class="tab-icon">üìã</div>
                <div class="tab-label">Risultati</div>
                <div class="tab-desc">Candidati trovati</div>
            </div>
        </div>

        <!-- Manual Panel -->
        <div class="panel active" id="panel-manual">
            <div class="card">
                <div class="card-title">‚öôÔ∏è Configurazione Ricerca</div>
                
                <label>Cognomi (uno per riga o separati da virgola)</label>
                <textarea id="cognomi-input" placeholder="Gasperoni&#10;Mularoni&#10;Zonzini&#10;..."></textarea>
                
                <button class="btn btn-secondary" onclick="loadDefaultCognomi()">
                    üì• Carica cognomi sammarinesi predefiniti
                </button>
            </div>

            <div class="card">
                <div class="card-title">üåç Paesi Target</div>
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <input type="checkbox" name="country" value="Argentina" checked> üá¶üá∑ Argentina
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="country" value="Brasil" checked> üáßüá∑ Brasile
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="country" value="USA" checked> üá∫üá∏ USA
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="country" value="Uruguay"> üá∫üáæ Uruguay
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="country" value="Venezuela"> üáªüá™ Venezuela
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="country" value="Chile"> üá®üá± Cile
                    </label>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üîó Fonti da cercare</div>
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <input type="checkbox" name="source" value="transfermarkt" checked> Transfermarkt
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="source" value="bdfa" checked> BDFA Argentina
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="source" value="soccerway" checked> Soccerway
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="source" value="ogol"> oGol
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="source" value="sofascore"> Sofascore
                    </label>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìù Query Generate</div>
                <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 15px;">
                    Clicca su una query per aprirla in Google. Poi aggiungi manualmente i risultati interessanti.
                </p>
                
                <div class="btn-row" style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="generateQueries()">
                        üîß Genera Query
                    </button>
                    <button class="btn btn-secondary" onclick="copyAllQueries()">
                        üìã Copia Tutte
                    </button>
                </div>

                <div id="queries-container"></div>
            </div>

            <div class="card">
                <div class="card-title">‚ûï Aggiungi Candidato Manualmente</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label>Nome completo</label>
                        <input type="text" id="manual-name" placeholder="Mario Gasperoni">
                    </div>
                    <div>
                        <label>Cognome sammarinese</label>
                        <input type="text" id="manual-surname" placeholder="Gasperoni">
                    </div>
                    <div>
                        <label>Et√† / Anno nascita</label>
                        <input type="text" id="manual-age" placeholder="24 o 2000">
                    </div>
                    <div>
                        <label>Paese</label>
                        <input type="text" id="manual-country" placeholder="Argentina">
                    </div>
                    <div>
                        <label>Club</label>
                        <input type="text" id="manual-club" placeholder="Boca Juniors">
                    </div>
                    <div>
                        <label>Ruolo</label>
                        <input type="text" id="manual-position" placeholder="Attaccante">
                    </div>
                </div>
                <label>Link fonte</label>
                <input type="text" id="manual-source" placeholder="https://transfermarkt.com/...">
                
                <button class="btn btn-primary" onclick="addManualCandidate()" style="margin-top: 10px;">
                    ‚ûï Aggiungi Candidato
                </button>
            </div>
        </div>

        <!-- Auto Panel -->
        <div class="panel" id="panel-auto">
            <div class="card">
                <div class="card-title">üîë API Key Serper</div>
                <label>Serper.dev API Key</label>
                <input type="password" id="serper-key" placeholder="Inserisci la tua API key">
                <p style="color: var(--text-secondary); font-size: 0.8rem;">
                    Ottieni una API key gratis su <a href="https://serper.dev" target="_blank" style="color: var(--accent-blue);">serper.dev</a> (2500 ricerche gratuite)
                </p>
                <button class="btn btn-secondary" onclick="saveApiKey()" style="margin-top: 10px;">
                    üíæ Salva in locale
                </button>
            </div>

            <div class="card">
                <div class="card-title">üéØ Cognomi da cercare</div>
                <div id="cognomi-preview" class="cognomi-preview">
                    <span style="color: var(--text-secondary);">Carica i cognomi nel tab Manuale</span>
                </div>
                
                <label>Priorit√† cognomi</label>
                <select id="cognomi-priority">
                    <option value="rare">Solo RARI (alta probabilit√†)</option>
                    <option value="medium" selected>Rari + Medi</option>
                    <option value="all">Tutti</option>
                </select>

                <label>Limite ricerche (per non esaurire crediti)</label>
                <input type="number" id="search-limit" value="20" min="1" max="100">
            </div>

            <div class="card">
                <div class="card-title">üöÄ Avvia Ricerca Automatica</div>
                <button class="btn btn-primary" onclick="startAutoSearch()" id="btn-auto-search">
                    ‚ö° Avvia Ricerca
                </button>
                
                <div class="progress-bar" id="progress-bar" style="display: none;">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <p id="progress-text" style="text-align: center; color: var(--text-secondary); font-size: 0.85rem;"></p>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Ricerca in corso...</p>
                <p id="loading-status" style="color: var(--text-secondary); font-size: 0.85rem;"></p>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="panel" id="panel-results">
            <div class="stats-bar" id="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label">Candidati</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-high">0</div>
                    <div class="stat-label">Alta prob.</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-medium">0</div>
                    <div class="stat-label">Media prob.</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-low">0</div>
                    <div class="stat-label">Bassa prob.</div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üéØ Candidati Trovati</div>
                <div id="results-list">
                    <p style="color: var(--text-secondary); text-align: center; padding: 30px;">
                        Nessun candidato ancora. Usa il tab Manuale o Automatico per cercare.
                    </p>
                </div>
            </div>

            <div class="export-section">
                <div class="btn-row">
                    <button class="btn btn-primary" onclick="exportCSV()">
                        üìÑ Esporta CSV
                    </button>
                    <button class="btn btn-secondary" onclick="exportJSON()">
                        üì¶ Esporta JSON
                    </button>
                    <button class="btn btn-secondary" onclick="clearResults()">
                        üóëÔ∏è Pulisci Tutto
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ==========================================
        // COGNOMI SAMMARINESI (CATEGORIZZATI)
        // ==========================================
        
        const COGNOMI_RARI = [
            "Gasperoni", "Mularoni", "Zonzini", "Zafferani", "Vitaioli", "Bacciocchi",
            "Podeschi", "Muraccini", "Capicchioni", "Volpinari", "Stolfi", "Cioncolini",
            "Tamagnini", "Simoncini", "Stefanelli", "Matteoni", "Giardi", "Ghiotti",
            "Selva", "Maiani", "Raschi", "Felici", "Ercolani", "Cevoli", "Benedettini"
        ];

        const COGNOMI_MEDI = [
            "Casadei", "Zanotti", "Guidi", "Della Valle", "Nanni", "Valli", "Pasolini",
            "Francini", "Michelotti", "Renzetti", "Salvini", "Carchia", "Graziani",
            "Lombardi", "Marquisio", "Riva", "Zoli", "Amati", "Angelini", "Arlotti",
            "Balducci", "Barberini", "Bartolini", "Bellini", "Benvenuti", "Bernardi",
            "Borghesi", "Calzolari", "Cardelli", "Cardinali", "Casali", "Castelli",
            "Cesarini", "Clementi", "Conti", "Costantini", "Damiani", "Dini", "Donati"
        ];

        const COGNOMI_COMUNI = [
            "Rossi", "Bianchi", "Valentini", "Ceci", "Ferrari", "Fabbri", "Marchetti",
            "Marconi", "Montanari", "Paolini", "Rinaldi", "Santi", "Villa"
        ];

        // State
        let candidates = JSON.parse(localStorage.getItem('titan_candidates') || '[]');
        let currentCognomi = [];

        // ==========================================
        // TABS
        // ==========================================

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`panel-${tab.dataset.tab}`).classList.add('active');
                
                if (tab.dataset.tab === 'results') {
                    renderResults();
                }
                if (tab.dataset.tab === 'auto') {
                    updateCognomiPreview();
                }
            });
        });

        // ==========================================
        // COGNOMI LOADING
        // ==========================================

        function loadDefaultCognomi() {
            const all = [...COGNOMI_RARI, ...COGNOMI_MEDI, ...COGNOMI_COMUNI];
            document.getElementById('cognomi-input').value = all.join('\n');
            currentCognomi = all;
            showToast(`Caricati ${all.length} cognomi sammarinesi`);
            updateCognomiPreview();
        }

        function parseCognomi() {
            const input = document.getElementById('cognomi-input').value;
            const cognomi = input.split(/[\n,]/)
                .map(c => c.trim())
                .filter(c => c.length > 0);
            currentCognomi = cognomi;
            return cognomi;
        }

        function categorizeCognome(cognome) {
            const upper = cognome.charAt(0).toUpperCase() + cognome.slice(1).toLowerCase();
            if (COGNOMI_RARI.includes(upper)) return 'rare';
            if (COGNOMI_MEDI.includes(upper)) return 'medium';
            return 'common';
        }

        function updateCognomiPreview() {
            parseCognomi();
            const container = document.getElementById('cognomi-preview');
            
            if (currentCognomi.length === 0) {
                container.innerHTML = '<span style="color: var(--text-secondary);">Carica i cognomi nel tab Manuale</span>';
                return;
            }

            container.innerHTML = currentCognomi.map(c => {
                const cat = categorizeCognome(c);
                return `<span class="cognome-tag ${cat}">${c}</span>`;
            }).join('');
        }

        // ==========================================
        // QUERY GENERATION (MANUAL MODE)
        // ==========================================

        function generateQueries() {
            const cognomi = parseCognomi();
            if (cognomi.length === 0) {
                showToast('Inserisci almeno un cognome');
                return;
            }

            const countries = Array.from(document.querySelectorAll('input[name="country"]:checked'))
                .map(c => c.value);
            const sources = Array.from(document.querySelectorAll('input[name="source"]:checked'))
                .map(s => s.value);

            const sourceMap = {
                'transfermarkt': 'site:transfermarkt.com',
                'bdfa': 'site:bdfa.com.ar',
                'soccerway': 'site:soccerway.com',
                'ogol': 'site:ogol.com.br',
                'sofascore': 'site:sofascore.com'
            };

            const queries = [];

            // Prioritize rare surnames
            const sortedCognomi = cognomi.sort((a, b) => {
                const catA = categorizeCognome(a);
                const catB = categorizeCognome(b);
                const order = { rare: 0, medium: 1, common: 2 };
                return order[catA] - order[catB];
            });

            // Generate queries (limit to avoid too many)
            const maxQueries = 30;
            let count = 0;

            for (const cognome of sortedCognomi) {
                if (count >= maxQueries) break;
                
                const cat = categorizeCognome(cognome);
                
                for (const source of sources) {
                    if (count >= maxQueries) break;
                    
                    // For common surnames, only use site-specific searches
                    if (cat === 'common' && sources.length > 1) {
                        // Skip some combinations for common names
                        if (source !== 'transfermarkt' && source !== 'bdfa') continue;
                    }

                    const siteQuery = sourceMap[source];
                    const countryTerms = countries.map(c => {
                        if (c === 'Brasil') return 'brasileiro OR Brazil';
                        if (c === 'USA') return 'american OR USA OR MLS';
                        return c.toLowerCase();
                    }).join(' OR ');

                    const query = `${siteQuery} "${cognome}" (${countryTerms}) futbolista OR player OR jogador`;
                    queries.push({
                        cognome,
                        category: cat,
                        source,
                        query,
                        url: `https://www.google.com/search?q=${encodeURIComponent(query)}`
                    });
                    count++;
                }
            }

            renderQueries(queries);
            showToast(`Generate ${queries.length} query`);
        }

        function renderQueries(queries) {
            const container = document.getElementById('queries-container');
            
            if (queries.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">Nessuna query generata</p>';
                return;
            }

            container.innerHTML = queries.map((q, i) => `
                <div class="query-box clickable" onclick="window.open('${q.url}', '_blank')" title="Clicca per cercare su Google">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span class="cognome-tag ${q.category}">${q.cognome}</span>
                        <span style="color: var(--text-secondary); font-size: 0.75rem;">${q.source}</span>
                    </div>
                    <code style="font-size: 0.8rem; color: var(--text-secondary);">${q.query}</code>
                </div>
            `).join('');
        }

        function copyAllQueries() {
            const boxes = document.querySelectorAll('#queries-container .query-box code');
            const queries = Array.from(boxes).map(b => b.textContent).join('\n\n');
            
            if (queries) {
                navigator.clipboard.writeText(queries);
                showToast('Query copiate negli appunti');
            } else {
                showToast('Genera prima le query');
            }
        }

        // ==========================================
        // MANUAL CANDIDATE ENTRY
        // ==========================================

        function addManualCandidate() {
            const name = document.getElementById('manual-name').value.trim();
            const surname = document.getElementById('manual-surname').value.trim();
            const age = document.getElementById('manual-age').value.trim();
            const country = document.getElementById('manual-country').value.trim();
            const club = document.getElementById('manual-club').value.trim();
            const position = document.getElementById('manual-position').value.trim();
            const source = document.getElementById('manual-source').value.trim();

            if (!name || !surname) {
                showToast('Nome e cognome sono obbligatori');
                return;
            }

            const candidate = {
                id: Date.now(),
                name,
                surname,
                age,
                country,
                club,
                position,
                source,
                category: categorizeCognome(surname),
                score: calculateScore(surname, country),
                addedAt: new Date().toISOString()
            };

            candidates.push(candidate);
            saveCandidates();
            
            // Clear form
            ['name', 'surname', 'age', 'country', 'club', 'position', 'source'].forEach(f => {
                document.getElementById(`manual-${f}`).value = '';
            });

            showToast(`Aggiunto: ${name}`);
            updateStats();
        }

        function calculateScore(surname, country) {
            let score = 0;
            
            // Surname rarity
            const cat = categorizeCognome(surname);
            if (cat === 'rare') score += 3;
            else if (cat === 'medium') score += 2;
            else score += 1;

            // Target country
            const targetCountries = ['argentina', 'brasil', 'brazil', 'usa', 'estados unidos', 'uruguay'];
            if (targetCountries.some(c => country.toLowerCase().includes(c))) {
                score += 2;
            }

            return score;
        }

        // ==========================================
        // AUTOMATIC SEARCH (SERPER)
        // ==========================================

        function saveApiKey() {
            const key = document.getElementById('serper-key').value.trim();
            if (key) {
                localStorage.setItem('serper_api_key', key);
                showToast('API key salvata');
            }
        }

        async function startAutoSearch() {
            const apiKey = document.getElementById('serper-key').value.trim() || 
                           localStorage.getItem('serper_api_key');
            
            if (!apiKey) {
                showToast('Inserisci la API key di Serper');
                return;
            }

            parseCognomi();
            if (currentCognomi.length === 0) {
                showToast('Carica i cognomi prima');
                return;
            }

            const priority = document.getElementById('cognomi-priority').value;
            const limit = parseInt(document.getElementById('search-limit').value) || 20;

            // Filter cognomi by priority
            let searchCognomi = currentCognomi.filter(c => {
                const cat = categorizeCognome(c);
                if (priority === 'rare') return cat === 'rare';
                if (priority === 'medium') return cat === 'rare' || cat === 'medium';
                return true;
            }).slice(0, limit);

            if (searchCognomi.length === 0) {
                showToast('Nessun cognome da cercare con questa priorit√†');
                return;
            }

            // UI updates
            document.getElementById('btn-auto-search').disabled = true;
            document.getElementById('progress-bar').style.display = 'block';
            document.getElementById('loading').classList.add('active');

            let processed = 0;
            const total = searchCognomi.length;

            for (const cognome of searchCognomi) {
                try {
                    document.getElementById('loading-status').textContent = `Cercando: ${cognome}...`;
                    document.getElementById('progress-text').textContent = `${processed + 1} / ${total}`;
                    
                    await searchSerper(apiKey, cognome);
                    
                    processed++;
                    document.getElementById('progress-fill').style.width = `${(processed / total) * 100}%`;
                    
                    // Rate limiting
                    await sleep(500);
                } catch (err) {
                    console.error(`Error searching ${cognome}:`, err);
                }
            }

            // Done
            document.getElementById('btn-auto-search').disabled = false;
            document.getElementById('loading').classList.remove('active');
            document.getElementById('progress-text').textContent = 'Completato!';
            
            showToast(`Ricerca completata. Trovati ${candidates.length} candidati.`);
            
            // Switch to results
            document.querySelector('.tab[data-tab="results"]').click();
        }

        async function searchSerper(apiKey, cognome) {
            const countries = ['Argentina', 'Brasil', 'USA'];
            
            for (const country of countries) {
                const query = `"${cognome}" futbolista OR player ${country} site:transfermarkt.com OR site:bdfa.com.ar`;
                
                try {
                    const response = await fetch('https://google.serper.dev/search', {
                        method: 'POST',
                        headers: {
                            'X-API-KEY': apiKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            q: query,
                            num: 10
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Serper API error: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.organic) {
                        for (const result of data.organic) {
                            // Parse result and add candidate if relevant
                            const candidate = parseSearchResult(result, cognome, country);
                            if (candidate && !isDuplicate(candidate)) {
                                candidates.push(candidate);
                                saveCandidates();
                            }
                        }
                    }
                } catch (err) {
                    console.error(`Serper error for ${cognome} in ${country}:`, err);
                }
            }
        }

        function parseSearchResult(result, cognome, country) {
            const title = result.title || '';
            const snippet = result.snippet || '';
            const link = result.link || '';

            // Skip if it's about San Marino national team
            if (snippet.toLowerCase().includes('san marino') && 
                (snippet.toLowerCase().includes('nazionale') || snippet.toLowerCase().includes('national'))) {
                return null;
            }

            // Skip Italian leagues
            const italianLeagues = ['serie a', 'serie b', 'serie c', 'serie d', 'primavera', 'italia'];
            if (italianLeagues.some(l => snippet.toLowerCase().includes(l))) {
                return null;
            }

            // Try to extract name from title
            const nameMatch = title.match(/^([A-Za-z√Ä-√ø\s]+)/);
            const name = nameMatch ? nameMatch[1].trim() : title;

            // Try to extract age/year
            const yearMatch = snippet.match(/\b(19[89]\d|20[0-2]\d)\b/);
            const age = yearMatch ? yearMatch[1] : '';

            return {
                id: Date.now() + Math.random(),
                name: name,
                surname: cognome,
                age: age,
                country: country,
                club: '',
                position: '',
                source: link,
                category: categorizeCognome(cognome),
                score: calculateScore(cognome, country),
                addedAt: new Date().toISOString(),
                snippet: snippet
            };
        }

        function isDuplicate(candidate) {
            return candidates.some(c => 
                c.name.toLowerCase() === candidate.name.toLowerCase() ||
                c.source === candidate.source
            );
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ==========================================
        // RESULTS
        // ==========================================

        function saveCandidates() {
            localStorage.setItem('titan_candidates', JSON.stringify(candidates));
            updateStats();
        }

        function updateStats() {
            const high = candidates.filter(c => c.score >= 4).length;
            const medium = candidates.filter(c => c.score >= 2 && c.score < 4).length;
            const low = candidates.filter(c => c.score < 2).length;

            document.getElementById('stat-total').textContent = candidates.length;
            document.getElementById('stat-high').textContent = high;
            document.getElementById('stat-medium').textContent = medium;
            document.getElementById('stat-low').textContent = low;
        }

        function renderResults() {
            updateStats();
            const container = document.getElementById('results-list');

            if (candidates.length === 0) {
                container.innerHTML = `
                    <p style="color: var(--text-secondary); text-align: center; padding: 30px;">
                        Nessun candidato ancora. Usa il tab Manuale o Automatico per cercare.
                    </p>
                `;
                return;
            }

            // Sort by score (highest first)
            const sorted = [...candidates].sort((a, b) => b.score - a.score);

            container.innerHTML = sorted.map(c => {
                const scoreClass = c.score >= 4 ? 'score-high' : (c.score >= 2 ? 'score-medium' : 'score-low');
                const scoreLabel = c.score >= 4 ? 'üî¥ ALTA' : (c.score >= 2 ? 'üü° MEDIA' : 'üü¢ BASSA');
                
                return `
                    <div class="result-item">
                        <div class="result-header">
                            <div class="result-name">${c.name}</div>
                            <div class="result-score ${scoreClass}">${scoreLabel}</div>
                        </div>
                        <div class="result-meta">
                            <span>üìõ ${c.surname}</span>
                            ${c.age ? `<span>üìÖ ${c.age}</span>` : ''}
                            ${c.country ? `<span>üåç ${c.country}</span>` : ''}
                            ${c.club ? `<span>‚öΩ ${c.club}</span>` : ''}
                            ${c.position ? `<span>üë§ ${c.position}</span>` : ''}
                        </div>
                        ${c.snippet ? `<p style="font-size: 0.85rem; color: var(--text-secondary); margin: 8px 0;">${c.snippet}</p>` : ''}
                        ${c.source ? `<div class="result-source"><a href="${c.source}" target="_blank">${c.source}</a></div>` : ''}
                        <button onclick="removeCandidate(${c.id})" style="margin-top: 10px; padding: 5px 10px; background: transparent; border: 1px solid var(--accent-red); color: var(--accent-red); border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                            üóëÔ∏è Rimuovi
                        </button>
                    </div>
                `;
            }).join('');
        }

        function removeCandidate(id) {
            candidates = candidates.filter(c => c.id !== id);
            saveCandidates();
            renderResults();
            showToast('Candidato rimosso');
        }

        function clearResults() {
            if (confirm('Sei sicuro di voler eliminare tutti i candidati?')) {
                candidates = [];
                saveCandidates();
                renderResults();
                showToast('Tutti i candidati eliminati');
            }
        }

        // ==========================================
        // EXPORT
        // ==========================================

        function exportCSV() {
            if (candidates.length === 0) {
                showToast('Nessun candidato da esportare');
                return;
            }

            const headers = ['Nome', 'Cognome', 'Et√†', 'Paese', 'Club', 'Ruolo', 'Score', 'Categoria', 'Fonte'];
            const rows = candidates.map(c => [
                c.name, c.surname, c.age, c.country, c.club, c.position, c.score, c.category, c.source
            ]);

            const csv = [headers, ...rows].map(row => row.map(cell => `"${cell || ''}"`).join(',')).join('\n');
            
            downloadFile(csv, 'titan_veritas_candidati.csv', 'text/csv');
            showToast('CSV esportato');
        }

        function exportJSON() {
            if (candidates.length === 0) {
                showToast('Nessun candidato da esportare');
                return;
            }

            const json = JSON.stringify(candidates, null, 2);
            downloadFile(json, 'titan_veritas_candidati.json', 'application/json');
            showToast('JSON esportato');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ==========================================
        // UTILS
        // ==========================================

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved API key
            const savedKey = localStorage.getItem('serper_api_key');
            if (savedKey) {
                document.getElementById('serper-key').value = savedKey;
            }
            
            updateStats();
        });
    </script>
</body>
</html>
