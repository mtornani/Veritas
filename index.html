<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TITAN SCOUT</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; margin: 0; padding: 0; font-family: system-ui, sans-serif; }
        body { background: #0a0a0f; color: #e0e0e0; }
        
        .btn { 
            padding: 14px; border-radius: 10px; font-weight: 600; 
            display: flex; align-items: center; justify-content: center; gap: 8px;
            border: none; cursor: pointer; width: 100%; font-size: 14px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: #0891b2; color: white; }
        .btn-primary:disabled { opacity: 0.5; }
        .btn-stop { background: #dc2626; color: white; }
        .btn-secondary { background: #1e293b; color: #94a3b8; border: 1px solid #334155; }
        
        .input { 
            width: 100%; background: #111118; border: 1px solid #2a2a3a; 
            border-radius: 8px; padding: 12px; color: white; font-size: 14px; 
        }
        .input:focus { outline: none; border-color: #0891b2; }
        
        .card { background: #12121a; border-radius: 12px; padding: 14px; margin-bottom: 10px; }
        .log { background: #000; border-radius: 8px; padding: 10px; height: 140px; overflow-y: auto; font-family: monospace; font-size: 11px; color: #4ade80; }
        
        .candidate { background: #1a1a24; border-left: 3px solid #0891b2; border-radius: 8px; padding: 12px; margin-bottom: 8px; }
        .candidate.priority { border-left-color: #f59e0b; background: #1a1812; }
        .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
        .tag-rare { background: #f59e0b; color: black; }
        .tag-country { background: #334155; color: #94a3b8; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // =============================================
        // CONFIGURAZIONE
        // =============================================
        
        const CONFIG = {
            // API Keys (preconfigurate)
            SERPER_KEY: '786d5959a5e293d4a3553de6176744acccf9da78',
            OPENROUTER_KEY: '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',
            AI_MODEL: 'x-ai/grok-4.1-fast',
            
            // Filtri
            MIN_YEAR: 1995,
            MAX_YEAR: 2009,
            
            // Cognomi rari (alta probabilit√† sammarinese)
            RARE_SURNAMES: [
                'Gasperoni', 'Mularoni', 'Zonzini', 'Zafferani', 'Vitaioli', 'Bacciocchi',
                'Podeschi', 'Muraccini', 'Capicchioni', 'Volpinari', 'Stolfi', 'Cioncolini',
                'Tamagnini', 'Simoncini', 'Stefanelli', 'Matteoni', 'Giardi', 'Ghiotti',
                'Benedettini', 'Cevoli'
            ],
            
            // Zone di ricerca
            ZONES: [
                { id: 'ARG', name: 'üá¶üá∑ Argentina', query: (s) => `site:bdfa.com.ar "${s}" futbolista` },
                { id: 'ARG2', name: 'üá¶üá∑ Argentina TM', query: (s) => `site:transfermarkt.com.ar "${s}"` },
                { id: 'BRA', name: 'üáßüá∑ Brasile', query: (s) => `site:ogol.com.br "${s}" jogador` },
                { id: 'USA', name: 'üá∫üá∏ USA College', query: (s) => `site:.edu soccer roster "${s}"` },
                { id: 'USA2', name: 'üá∫üá∏ USA MLS', query: (s) => `site:mlssoccer.com "${s}"` }
            ],
            
            // Paesi da escludere
            EXCLUDED_COUNTRIES: ['italia', 'italy', 'san marino', 'sammarinese']
        };

        // =============================================
        // STATO GLOBALE
        // =============================================
        
        let state = {
            running: false,
            candidates: [],
            logs: [],
            surnames: CONFIG.RARE_SURNAMES.slice(0, 10).join('\n')
        };
        
        let cancelFlag = false;

        // =============================================
        // UTILITIES
        // =============================================
        
        function log(msg) {
            state.logs.push('> ' + msg);
            render();
            const logEl = document.querySelector('.log');
            if (logEl) logEl.scrollTop = logEl.scrollHeight;
        }

        function isRare(surname) {
            return CONFIG.RARE_SURNAMES.some(r => 
                surname.toLowerCase().includes(r.toLowerCase()) || 
                r.toLowerCase().includes(surname.toLowerCase())
            );
        }

        function isExcludedCountry(country) {
            if (!country) return false;
            const c = country.toLowerCase();
            return CONFIG.EXCLUDED_COUNTRIES.some(ex => c.includes(ex));
        }

        // =============================================
        // API CALLS
        // =============================================
        
        async function searchSerper(query) {
            const response = await fetch('https://google.serper.dev/search', {
                method: 'POST',
                headers: { 
                    'X-API-KEY': CONFIG.SERPER_KEY, 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify({ q: query, num: 10, gl: 'ar' })
            });
            
            if (!response.ok) throw new Error(`Serper HTTP ${response.status}`);
            
            const data = await response.json();
            if (!data.organic || data.organic.length === 0) return null;
            
            // Filtra risultati irrilevanti
            const filtered = data.organic.filter(r => {
                const txt = ((r.title || '') + (r.snippet || '')).toLowerCase();
                return !txt.includes('hotel') && !txt.includes('restaurant') && !txt.includes('obituary');
            });
            
            if (filtered.length === 0) return null;
            
            return filtered.map(r => ({
                title: r.title || '',
                snippet: r.snippet || '',
                link: r.link || ''
            }));
        }

        async function extractWithAI(results, surname, zone) {
            const prompt = `Sei TITAN SCOUT, un sistema di identificazione calciatori.

DATI DA ANALIZZARE:
${results.map(r => `- ${r.title}\n  ${r.snippet}\n  ${r.link}`).join('\n\n')}

COGNOME CERCATO: ${surname}
ZONA: ${zone}

COMPITO:
Estrai SOLO calciatori maschi che hanno il cognome "${surname}" (o varianti simili).

FILTRI OBBLIGATORI:
- Et√†: nati tra ${CONFIG.MIN_YEAR} e ${CONFIG.MAX_YEAR} (o che sembrano under 30)
- ESCLUDI chi gioca in Italia o San Marino
- ESCLUDI chi gioca gi√† per la nazionale di San Marino
- INCLUDI SOLO chi gioca in campionati esteri (Argentina, Brasile, USA, etc.)

OUTPUT (solo JSON array, nient'altro):
[
  {
    "nome": "Nome Completo",
    "anno": "YYYY o null se sconosciuto", 
    "club": "Nome squadra",
    "paese": "Paese del campionato",
    "ruolo": "Ruolo se noto",
    "fonte": "URL fonte",
    "note": "Qualsiasi info utile sulla possibile origine"
  }
]

Se non trovi nessun candidato valido, rispondi con: []`;

            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${CONFIG.OPENROUTER_KEY}`,
                    'Content-Type': 'application/json',
                    'HTTP-Referer': 'https://titan-scout.app'
                },
                body: JSON.stringify({
                    model: CONFIG.AI_MODEL,
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.1,
                    max_tokens: 2000
                })
            });

            if (!response.ok) throw new Error(`AI HTTP ${response.status}`);
            
            const data = await response.json();
            const content = data.choices?.[0]?.message?.content || '[]';
            
            // Estrai JSON
            try {
                const match = content.match(/\[[\s\S]*\]/);
                if (!match) return [];
                return JSON.parse(match[0]);
            } catch {
                return [];
            }
        }

        // =============================================
        // CORE LOGIC
        // =============================================
        
        async function runScan() {
            cancelFlag = false;
            state.running = true;
            state.candidates = [];
            state.logs = ['üöÄ TITAN SCOUT avviato...'];
            render();

            const surnames = state.surnames.split(/[\n,]+/).map(s => s.trim()).filter(Boolean);
            log(`üìã ${surnames.length} cognomi da cercare`);
            log(`üéØ Zone: ${CONFIG.ZONES.map(z => z.id).join(', ')}`);
            log(`üìÖ Et√†: ${CONFIG.MIN_YEAR}-${CONFIG.MAX_YEAR}`);
            log('‚îÄ'.repeat(30));

            for (const surname of surnames) {
                if (cancelFlag) break;
                
                const rare = isRare(surname);
                log(`\n${rare ? '‚≠ê' : '‚óã'} ${surname.toUpperCase()}${rare ? ' (RARO)' : ''}`);

                for (const zone of CONFIG.ZONES) {
                    if (cancelFlag) break;
                    
                    log(`  ${zone.name}...`);
                    
                    try {
                        // Cerca su Serper
                        const results = await searchSerper(zone.query(surname));
                        
                        if (!results) {
                            log(`    ‚ö™ Nessun risultato`);
                            continue;
                        }
                        
                        log(`    üìÑ ${results.length} risultati, analisi AI...`);
                        
                        // Estrai con AI
                        const candidates = await extractWithAI(results, surname, zone.name);
                        
                        // Filtra e aggiungi
                        const valid = candidates.filter(c => {
                            if (isExcludedCountry(c.paese)) return false;
                            if (c.anno) {
                                const y = parseInt(c.anno);
                                if (!isNaN(y) && (y < CONFIG.MIN_YEAR || y > CONFIG.MAX_YEAR)) return false;
                            }
                            return true;
                        });
                        
                        if (valid.length > 0) {
                            log(`    ‚úÖ ${valid.length} candidati!`);
                            valid.forEach(c => {
                                c.cognome_cercato = surname;
                                c.zona = zone.id;
                                c.is_rare = rare;
                                state.candidates.push(c);
                            });
                            render();
                        } else {
                            log(`    ‚ö™ Nessun candidato valido`);
                        }
                        
                    } catch (err) {
                        log(`    ‚ùå Errore: ${err.message}`);
                    }
                    
                    // Rate limiting
                    await new Promise(r => setTimeout(r, 800));
                }
            }

            // Rimuovi duplicati
            const seen = new Set();
            state.candidates = state.candidates.filter(c => {
                const key = (c.nome || '').toLowerCase();
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });

            // Ordina: prima i rari
            state.candidates.sort((a, b) => (b.is_rare ? 1 : 0) - (a.is_rare ? 1 : 0));

            log('\n' + '‚îÄ'.repeat(30));
            log(`üèÅ COMPLETATO: ${state.candidates.length} candidati trovati`);
            log(`‚≠ê Di cui cognomi rari: ${state.candidates.filter(c => c.is_rare).length}`);
            
            state.running = false;
            render();
        }

        function stopScan() {
            cancelFlag = true;
            state.running = false;
            log('üõë Scansione interrotta');
            render();
        }

        // =============================================
        // PDF EXPORT
        // =============================================
        
        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const date = new Date().toLocaleDateString('it-IT');
            
            // Header
            doc.setFillColor(8, 145, 178);
            doc.rect(0, 0, 210, 25, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.text('TITAN SCOUT - Candidati Oriundi RSM', 10, 12);
            doc.setFontSize(10);
            doc.text(`Generato: ${date} | Candidati: ${state.candidates.length}`, 10, 20);
            
            // Info
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);
            doc.text(`Filtro et√†: ${CONFIG.MIN_YEAR}-${CONFIG.MAX_YEAR} | Esclusi: Italia, San Marino`, 10, 32);
            doc.text('‚≠ê = Cognome tipicamente sammarinese (alta probabilit√†)', 10, 38);
            
            // Tabella
            const tableData = state.candidates.map(c => [
                (c.is_rare ? '‚≠ê ' : '') + (c.nome || '?'),
                c.anno || '?',
                c.club || '?',
                c.paese || '?',
                (c.note || '').substring(0, 40)
            ]);

            doc.autoTable({
                startY: 44,
                head: [['Nome', 'Anno', 'Club', 'Paese', 'Note']],
                body: tableData,
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [15, 23, 42], textColor: 255 },
                columnStyles: {
                    0: { cellWidth: 45 },
                    1: { cellWidth: 15 },
                    2: { cellWidth: 40 },
                    3: { cellWidth: 25 },
                    4: { cellWidth: 55 }
                },
                didParseCell: function(data) {
                    if (data.section === 'body' && data.row.raw[0].startsWith('‚≠ê')) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.fillColor = [255, 251, 235];
                    }
                }
            });

            // Footer con fonti
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(8);
            doc.setTextColor(100);
            doc.text('Fonti: BDFA.com.ar, Transfermarkt, MLS, College Soccer USA', 10, finalY);
            doc.text('Sistema: TITAN SCOUT by Mirko Cevoli', 10, finalY + 5);
            
            doc.save(`TITAN_Scout_${date.replace(/\//g, '-')}.pdf`);
        }

        // =============================================
        // RENDER
        // =============================================
        
        function render() {
            const app = document.getElementById('app');
            
            app.innerHTML = `
                <div style="padding: 12px; max-width: 600px; margin: 0 auto;">
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <h1 style="margin: 0; font-size: 20px; color: #0891b2;">TITAN SCOUT</h1>
                            <div style="font-size: 11px; color: #666;">Oriundi Finder RSM v1.0</div>
                        </div>
                        <div style="text-align: right; font-size: 10px; color: #666;">
                            API: ‚úì Serper ‚úì Grok
                        </div>
                    </div>
                    
                    <!-- Input -->
                    <div class="card">
                        <div style="margin-bottom: 8px; font-size: 12px; color: #888;">
                            Cognomi da cercare (uno per riga):
                        </div>
                        <textarea 
                            class="input" 
                            style="min-height: 100px; font-family: monospace; font-size: 12px;"
                            ${state.running ? 'disabled' : ''}
                        >${state.surnames}</textarea>
                        
                        <div style="display: flex; gap: 8px; margin-top: 10px;">
                            ${state.running ? `
                                <button class="btn btn-stop" onclick="stopScan()">
                                    ‚¨õ STOP
                                </button>
                            ` : `
                                <button class="btn btn-primary" onclick="startScan()">
                                    ‚ö° AVVIA RICERCA
                                </button>
                            `}
                        </div>
                        
                        <!-- Logs -->
                        <div class="log" style="margin-top: 10px;">
                            ${state.logs.join('\n')}
                        </div>
                    </div>
                    
                    <!-- Results -->
                    ${state.candidates.length > 0 ? `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin: 12px 0 8px;">
                            <span style="font-size: 14px; font-weight: 600; color: #0891b2;">
                                ${state.candidates.length} Candidati
                            </span>
                            <button class="btn btn-primary" style="width: auto; padding: 8px 16px;" onclick="exportPDF()">
                                üìÑ PDF
                            </button>
                        </div>
                        
                        ${state.candidates.map(c => `
                            <div class="candidate ${c.is_rare ? 'priority' : ''}">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="font-weight: 600;">${c.nome || '?'}</div>
                                    <div style="display: flex; gap: 4px;">
                                        ${c.is_rare ? '<span class="tag tag-rare">‚≠ê RARO</span>' : ''}
                                        <span class="tag tag-country">${c.paese || '?'}</span>
                                    </div>
                                </div>
                                <div style="font-size: 12px; color: #888; margin-top: 4px;">
                                    ${c.anno || '?'} ‚Ä¢ ${c.club || '?'}${c.ruolo ? ' ‚Ä¢ ' + c.ruolo : ''}
                                </div>
                                ${c.note ? `<div style="font-size: 11px; color: #666; margin-top: 6px; font-style: italic;">${c.note}</div>` : ''}
                                ${c.fonte ? `<a href="${c.fonte}" target="_blank" style="font-size: 10px; color: #0891b2; margin-top: 4px; display: inline-block;">üîó Fonte</a>` : ''}
                            </div>
                        `).join('')}
                    ` : ''}
                </div>
            `;
            
            // Bind textarea
            const textarea = app.querySelector('textarea');
            if (textarea) {
                textarea.addEventListener('input', (e) => {
                    state.surnames = e.target.value;
                });
            }
        }

        // =============================================
        // GLOBAL FUNCTIONS
        // =============================================
        
        window.startScan = () => {
            runScan().catch(err => {
                log(`‚ùå Errore fatale: ${err.message}`);
                state.running = false;
                render();
            });
        };
        
        window.stopScan = stopScan;
        window.exportPDF = exportPDF;
        
        // Init
        render();
    </script>
</body>
</html>
