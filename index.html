<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITAN VERITAS v3.2 - Intelligence Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-card: #1c2128;
            --bg-elevated: #252c35;
            --accent-primary: #2f81f7;
            --accent-secondary: #1f6feb;
            --accent-success: #238636;
            --accent-warning: #d29922;
            --accent-danger: #da3633;
            --accent-gold: #c9a227;
            --accent-bdfa: #00a8e8;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --border-primary: #30363d;
            --border-secondary: #21262d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'IBM Plex Sans', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        .container { max-width: 960px; margin: 0 auto; padding: 16px; }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-primary);
            margin-bottom: 24px;
        }

        .header-left { display: flex; align-items: center; gap: 16px; }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .logo-text h1 { font-size: 1.25rem; font-weight: 700; letter-spacing: 1px; }
        .logo-text span { font-size: 0.75rem; color: var(--text-secondary); font-family: 'IBM Plex Mono', monospace; }

        .header-badge {
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-family: 'IBM Plex Mono', monospace;
            color: var(--text-secondary);
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: 4px;
            background: var(--bg-secondary);
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .nav-item {
            flex: 1;
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .nav-item:hover { color: var(--text-primary); background: var(--bg-elevated); }
        .nav-item.active { background: var(--bg-card); color: var(--text-primary); box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .nav-icon { font-size: 1rem; }

        /* Panels */
        .panel { display: none; }
        .panel.active { display: block; }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .card-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-secondary);
            font-weight: 600;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-secondary);
        }

        .card-body { padding: 16px; }

        /* Form Elements */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 0.8125rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
            transition: border-color 0.15s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(47, 129, 247, 0.15);
        }

        .form-textarea { min-height: 100px; resize: vertical; font-size: 0.8125rem; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-hint { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border: 1px solid transparent;
            border-radius: 6px;
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-primary { background: var(--accent-primary); color: #fff; }
        .btn-primary:hover { background: var(--accent-secondary); }
        .btn-secondary { background: var(--bg-elevated); border-color: var(--border-primary); color: var(--text-primary); }
        .btn-secondary:hover { background: var(--bg-card); border-color: var(--text-muted); }
        .btn-success { background: var(--accent-success); color: #fff; }
        .btn-warning { background: var(--accent-warning); color: #000; }
        .btn-danger { background: var(--accent-danger); color: #fff; }
        .btn-sm { padding: 6px 12px; font-size: 0.8125rem; }
        .btn-block { width: 100%; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

        /* Checkbox Grid */
        .checkbox-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8125rem;
            transition: all 0.15s;
        }

        .checkbox-item:hover { border-color: var(--border-primary); }
        .checkbox-item input { margin: 0; }
        
        .checkbox-item.highlight-bdfa {
            border-color: var(--accent-bdfa);
            background: rgba(0, 168, 232, 0.1);
        }

        /* Alert */
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 0.8125rem;
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .alert-info { background: rgba(47, 129, 247, 0.1); border: 1px solid rgba(47, 129, 247, 0.3); color: var(--accent-primary); }
        .alert-warning { background: rgba(210, 153, 34, 0.1); border: 1px solid rgba(210, 153, 34, 0.3); color: var(--accent-warning); }
        .alert-success { background: rgba(35, 134, 54, 0.1); border: 1px solid rgba(35, 134, 54, 0.3); color: var(--accent-success); }
        .alert-bdfa { background: rgba(0, 168, 232, 0.1); border: 1px solid rgba(0, 168, 232, 0.3); color: var(--accent-bdfa); }
        .alert-icon { font-size: 1rem; flex-shrink: 0; }

        /* Progress */
        .progress-wrapper { margin: 16px 0; }
        .progress-bar { height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-primary), var(--accent-success)); transition: width 0.3s; }
        .progress-label { font-size: 0.75rem; color: var(--text-secondary); margin-top: 6px; text-align: center; font-family: 'IBM Plex Mono', monospace; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--accent-primary); font-family: 'IBM Plex Mono', monospace; }
        .stat-value.warning { color: var(--accent-warning); }
        .stat-value.success { color: var(--accent-success); }
        .stat-value.danger { color: var(--accent-danger); }
        .stat-value.bdfa { color: var(--accent-bdfa); }
        .stat-label { font-size: 0.6875rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

        /* Filter Bar */
        .filter-bar { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }

        .filter-chip {
            padding: 6px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 20px;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .filter-chip:hover { border-color: var(--accent-primary); color: var(--text-primary); }
        .filter-chip.active { background: var(--accent-primary); border-color: var(--accent-primary); color: #fff; }

        /* Result Cards */
        .result-card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.15s;
        }

        .result-card:hover { border-color: var(--accent-primary); }
        .result-card.noise { opacity: 0.5; border-color: var(--accent-danger); }
        .result-card.verified { border-color: var(--accent-success); background: rgba(35, 134, 54, 0.05); }
        .result-card.player-profile { border-left: 3px solid var(--accent-success); }
        .result-card.bdfa-source { border-left: 3px solid var(--accent-bdfa); }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-secondary);
        }

        .result-name { font-weight: 600; font-size: 0.9375rem; }
        .result-badges { display: flex; gap: 6px; flex-wrap: wrap; }

        .badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-high { background: rgba(218, 54, 51, 0.15); color: var(--accent-danger); border: 1px solid var(--accent-danger); }
        .badge-medium { background: rgba(210, 153, 34, 0.15); color: var(--accent-warning); border: 1px solid var(--accent-warning); }
        .badge-low { background: rgba(35, 134, 54, 0.15); color: var(--accent-success); border: 1px solid var(--accent-success); }
        .badge-noise { background: rgba(110, 118, 129, 0.15); color: var(--text-muted); border: 1px solid var(--text-muted); }
        .badge-verified { background: var(--accent-success); color: #fff; }
        .badge-profile { background: rgba(47, 129, 247, 0.15); color: var(--accent-primary); border: 1px solid var(--accent-primary); }
        .badge-bdfa { background: rgba(0, 168, 232, 0.15); color: var(--accent-bdfa); border: 1px solid var(--accent-bdfa); }

        .result-body { padding: 12px 16px; }

        .result-meta { display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 10px; }

        .result-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .result-meta-item .icon { font-size: 0.875rem; }

        .result-snippet {
            font-size: 0.8125rem;
            color: var(--text-muted);
            background: var(--bg-secondary);
            padding: 10px 12px;
            border-radius: 6px;
            margin: 10px 0;
            line-height: 1.6;
        }

        .result-snippet mark {
            background: rgba(201, 162, 39, 0.3);
            color: var(--accent-gold);
            padding: 1px 3px;
            border-radius: 2px;
        }

        .result-link {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.6875rem;
            color: var(--accent-primary);
            word-break: break-all;
        }

        .result-link a { color: inherit; text-decoration: none; }
        .result-link a:hover { text-decoration: underline; }

        .result-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-secondary);
        }

        .result-actions { display: flex; gap: 8px; }

        .result-noise-reason {
            font-size: 0.75rem;
            color: var(--accent-warning);
            padding: 6px 10px;
            background: rgba(210, 153, 34, 0.1);
            border-radius: 4px;
            margin-top: 8px;
        }

        /* Category Tags */
        .category-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.6875rem;
            font-weight: 600;
            font-family: 'IBM Plex Mono', monospace;
            text-transform: uppercase;
        }

        .category-tag.rare { background: rgba(218, 54, 51, 0.15); color: var(--accent-danger); }
        .category-tag.medium { background: rgba(210, 153, 34, 0.15); color: var(--accent-warning); }
        .category-tag.common { background: rgba(110, 118, 129, 0.15); color: var(--text-muted); }

        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.5; }
        .empty-state-title { font-size: 1.125rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.875rem;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title { font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 1.25rem; cursor: pointer; padding: 4px; }
        .modal-close:hover { color: var(--text-primary); }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border-primary); display: flex; justify-content: flex-end; gap: 12px; }

        /* Mobile */
        @media (max-width: 640px) {
            .container { padding: 12px; }
            .header { flex-direction: column; gap: 12px; text-align: center; }
            .nav-item { padding: 8px 12px; font-size: 0.8125rem; }
            .nav-item span:not(.nav-icon) { display: none; }
            .checkbox-grid { grid-template-columns: repeat(2, 1fr); }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-left">
                <div class="logo-icon">üéØ</div>
                <div class="logo-text">
                    <h1>TITAN VERITAS</h1>
                    <span>Heritage Intelligence Platform v3.2</span>
                </div>
            </div>
            <div class="header-badge">FSGC ‚Ä¢ RSM</div>
        </header>

        <nav class="nav">
            <button class="nav-item active" data-tab="search"><span class="nav-icon">üîç</span><span>Ricerca</span></button>
            <button class="nav-item" data-tab="results"><span class="nav-icon">üìä</span><span>Analisi</span></button>
            <button class="nav-item" data-tab="verified"><span class="nav-icon">‚úì</span><span>Verificati</span></button>
            <button class="nav-item" data-tab="export"><span class="nav-icon">üìÑ</span><span>Report</span></button>
        </nav>

        <!-- Search Panel -->
        <div class="panel active" id="panel-search">
            <div class="alert alert-bdfa">
                <span class="alert-icon">üá¶üá∑</span>
                <div>
                    <strong>v3.2 - BDFA Argentina Boost:</strong> Query ottimizzate per bdfa.com.ar, parsing dedicato, priorit√† massima per profili BDFA argentini.
                </div>
            </div>

            <div class="card">
                <div class="card-header"><span>üîë</span> Configurazione API</div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Serper API Key</label>
                        <input type="password" class="form-input" id="serper-key" placeholder="Inserisci chiave API">
                        <div class="form-hint">Ottieni 2500 ricerche gratuite su <a href="https://serper.dev" target="_blank" style="color: var(--accent-primary);">serper.dev</a></div>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="saveApiKey()">Salva chiave</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><span>üìã</span> Database Cognomi</div>
                <div class="card-body">
                    <div class="btn-group" style="margin-bottom: 16px;">
                        <button class="btn btn-sm btn-secondary" onclick="loadCognomi('rare')">üî¥ Solo Rari</button>
                        <button class="btn btn-sm btn-secondary" onclick="loadCognomi('medium')">üü° Rari + Medi</button>
                        <button class="btn btn-sm btn-secondary" onclick="loadCognomi('all')">üì¶ Tutti</button>
                    </div>
                    <div class="form-group">
                        <textarea class="form-textarea" id="cognomi-input" placeholder="Un cognome per riga..."></textarea>
                    </div>
                    <div id="cognomi-stats"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><span>üåç</span> Aree Geografiche Target</div>
                <div class="card-body">
                    <div class="checkbox-grid">
                        <label class="checkbox-item highlight-bdfa"><input type="checkbox" name="country" value="Argentina" checked> üá¶üá∑ Argentina (BDFA)</label>
                        <label class="checkbox-item"><input type="checkbox" name="country" value="Brazil" checked> üáßüá∑ Brasile</label>
                        <label class="checkbox-item"><input type="checkbox" name="country" value="USA" checked> üá∫üá∏ Stati Uniti</label>
                        <label class="checkbox-item"><input type="checkbox" name="country" value="Uruguay"> üá∫üáæ Uruguay</label>
                        <label class="checkbox-item"><input type="checkbox" name="country" value="Paraguay"> üáµüáæ Paraguay</label>
                        <label class="checkbox-item"><input type="checkbox" name="country" value="Chile"> üá®üá± Cile</label>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><span>‚öôÔ∏è</span> Parametri Ricerca</div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Et√† Minima</label>
                            <input type="number" class="form-input" id="age-min" value="16" min="14" max="40">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Et√† Massima</label>
                            <input type="number" class="form-input" id="age-max" value="28" min="16" max="45">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Profondit√† Ricerca</label>
                            <select class="form-select" id="search-depth">
                                <option value="1">Veloce (1 query/cognome)</option>
                                <option value="2" selected>Standard (2 query/cognome)</option>
                                <option value="3">Approfondita (3 query/cognome)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Risultati per Query</label>
                            <select class="form-select" id="results-num">
                                <option value="5">5 risultati</option>
                                <option value="10" selected>10 risultati</option>
                                <option value="20">20 risultati</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-item" style="margin-top: 8px;">
                            <input type="checkbox" id="only-profiles" checked>
                            <span>üéØ Solo profili giocatore diretti</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-item highlight-bdfa">
                            <input type="checkbox" id="bdfa-priority" checked>
                            <span>üá¶üá∑ Priorit√† BDFA Argentina (raccomandato)</span>
                        </label>
                        <div class="form-hint">Esegue ricerche dedicate su bdfa.com.ar per ogni cognome</div>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary btn-block" onclick="startSearch()" id="btn-search">
                üöÄ Avvia Analisi Intelligence
            </button>

            <div class="progress-wrapper" id="progress-wrapper" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-label" id="progress-label">Inizializzazione...</div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="panel" id="panel-results">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label">Totale</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value success" id="stat-valid">0</div>
                    <div class="stat-label">Validi</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value bdfa" id="stat-bdfa">0</div>
                    <div class="stat-label">BDFA üá¶üá∑</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value warning" id="stat-filtered">0</div>
                    <div class="stat-label">Filtrati</div>
                </div>
            </div>

            <div class="filter-bar">
                <button class="filter-chip active" data-filter="valid">‚úì Validi</button>
                <button class="filter-chip" data-filter="bdfa">üá¶üá∑ BDFA</button>
                <button class="filter-chip" data-filter="priority">üî¥ Priorit√†</button>
                <button class="filter-chip" data-filter="all">üì¶ Tutti</button>
                <button class="filter-chip" data-filter="filtered">üóëÔ∏è Filtrati</button>
            </div>

            <div class="btn-group" style="margin-bottom: 16px;">
                <button class="btn btn-sm btn-secondary" onclick="clearResults()">üóëÔ∏è Pulisci tutto</button>
            </div>

            <div id="results-container"></div>
        </div>

        <!-- Verified Panel -->
        <div class="panel" id="panel-verified">
            <div class="alert alert-warning">
                <span class="alert-icon">‚ö†Ô∏è</span>
                <div><strong>NOTA:</strong> I candidati selezionati richiedono verifica tramite anagrafe RSM.</div>
            </div>

            <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="stat-card">
                    <div class="stat-value success" id="stat-verified-count">0</div>
                    <div class="stat-label">Selezionati</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value bdfa" id="stat-verified-bdfa">0</div>
                    <div class="stat-label">Da BDFA</div>
                </div>
            </div>

            <div id="verified-container"></div>
        </div>

        <!-- Export Panel -->
        <div class="panel" id="panel-export">
            <div class="card">
                <div class="card-header"><span>üìÑ</span> Genera Report</div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Titolo Report</label>
                        <input type="text" class="form-input" id="report-title" value="Candidati Oriundi - Analisi Preliminare">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Note Aggiuntive</label>
                        <textarea class="form-textarea" id="report-notes" placeholder="Eventuali note..."></textarea>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="previewReport()">üëÅÔ∏è Anteprima</button>
                        <button class="btn btn-success" onclick="downloadHTML()">üìÑ HTML</button>
                        <button class="btn btn-secondary" onclick="downloadCSV()">üìä CSV</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Anteprima Report</span>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Chiudi</button>
                <button class="btn btn-success" onclick="downloadHTML()">üìÑ HTML</button>
                <button class="btn btn-primary" onclick="printReport()">üñ®Ô∏è Stampa</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ==========================================
        // DATABASE COGNOMI
        // ==========================================
        
        const COGNOMI = {
            rare: [
                "Gasperoni", "Mularoni", "Zonzini", "Zafferani", "Vitaioli", "Bacciocchi",
                "Podeschi", "Muraccini", "Capicchioni", "Volpinari", "Stolfi", "Cioncolini",
                "Tamagnini", "Simoncini", "Matteoni", "Giardi", "Ghiotti", "Maiani", 
                "Raschi", "Cevoli"
            ],
            medium: [
                "Casadei", "Zanotti", "Guidi", "Selva", "Benedettini", "Stefanelli",
                "Della Valle", "Nanni", "Valli", "Pasolini", "Francini", "Felici", 
                "Ercolani", "Michelotti", "Renzetti", "Salvini", "Carchia", "Lombardi",
                "Marquisio", "Riva", "Zoli", "Amati", "Arlotti", "Balducci"
            ],
            common: [
                "Rossi", "Bianchi", "Valentini", "Ceci", "Ferrari", "Fabbri", 
                "Graziani", "Marchetti", "Montanari", "Rinaldi", "Santi"
            ]
        };

        // ==========================================
        // BLACKLIST
        // ==========================================

        const BLACKLIST = {
            clubsRSM: [
                "la fiorita", "tre penne", "tre fiori", "folgore", "libertas", 
                "cosmos", "murata", "domagnano", "faetano", "pennarossa", 
                "fiorentino", "juvenes", "dogana", "cailungo", "san giovanni",
                "virtus acquaviva", "san marino academy", "san marino calcio"
            ],
            
            clubsItaly: [
                "juventus", "inter", "milan", "roma", "napoli", "lazio", "fiorentina",
                "atalanta", "torino", "bologna", "sampdoria", "genoa", "verona",
                "cesena", "pistoiese", "rimini", "ravenna", "reggiana", "modena",
                "parma", "brescia", "como", "cremonese", "spal", "vicenza"
            ],

            leagues: [
                "serie a", "serie b", "serie c", "serie d", "lega pro",
                "eccellenza", "promozione", "campionato sammarinese"
            ],
            
            roles: [
                "manager", "coach", "allenatore", "director", "presidente", 
                "staff", "scout", "agent", "agente", "retired", "ritirato", "ex-"
            ],
            
            famousPlayers: [
                "messi", "ronaldo", "neymar", "mbappe", "de bruyne", "iniesta"
            ],
            
            urlBlacklist: [
                "/verein/", "/startseite/verein/", "saison_id", "/squad/",
                "spielegegeneinander", "gegner", "opponents",
                "marktwerte", "transfers", "berateruebersicht",
                "/news/", "/statistik/", "/staff/"
            ],
            
            urlWhitelist: [
                "/spieler/", "/profil/", "/player/", "/jugador/", "/jogador/",
                "bdfa.com.ar/jugadores"
            ],

            italianIndicators: [
                "italy,", "italia,", "italiano", ", italy", "nato in italia", "born in italy",
                "cesena,", "pistoiese,", "rimini,", "serie a", "serie b"
            ]
        };

        // ==========================================
        // STATE
        // ==========================================

        let candidates = JSON.parse(localStorage.getItem('titan_v32_candidates') || '[]');
        let verified = JSON.parse(localStorage.getItem('titan_v32_verified') || '[]');
        let currentFilter = 'valid';

        // ==========================================
        // INIT
        // ==========================================

        document.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('serper_api_key');
            if (savedKey) document.getElementById('serper-key').value = savedKey;
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => switchTab(item.dataset.tab));
            });

            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentFilter = chip.dataset.filter;
                    renderResults();
                });
            });

            document.getElementById('cognomi-input').addEventListener('input', updateCognomiStats);
            updateStats();
        });

        function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`.nav-item[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`panel-${tabId}`).classList.add('active');
            
            if (tabId === 'results') renderResults();
            if (tabId === 'verified') renderVerified();
        }

        // ==========================================
        // COGNOMI
        // ==========================================

        function loadCognomi(level) {
            let list = [];
            if (level === 'rare') list = COGNOMI.rare;
            else if (level === 'medium') list = [...COGNOMI.rare, ...COGNOMI.medium];
            else list = [...COGNOMI.rare, ...COGNOMI.medium, ...COGNOMI.common];
            
            document.getElementById('cognomi-input').value = list.join('\n');
            updateCognomiStats();
            showToast(`Caricati ${list.length} cognomi`);
        }

        function getCognomi() {
            return document.getElementById('cognomi-input').value.split('\n').map(c => c.trim()).filter(c => c.length > 0);
        }

        function getCognomeCategory(cognome) {
            const c = cognome.toLowerCase();
            if (COGNOMI.rare.map(x => x.toLowerCase()).includes(c)) return 'rare';
            if (COGNOMI.medium.map(x => x.toLowerCase()).includes(c)) return 'medium';
            return 'common';
        }

        function updateCognomiStats() {
            const cognomi = getCognomi();
            const stats = document.getElementById('cognomi-stats');
            if (cognomi.length === 0) { stats.innerHTML = ''; return; }
            const rare = cognomi.filter(c => getCognomeCategory(c) === 'rare').length;
            const medium = cognomi.filter(c => getCognomeCategory(c) === 'medium').length;
            const common = cognomi.filter(c => getCognomeCategory(c) === 'common').length;
            stats.innerHTML = `<div style="display:flex;gap:12px;font-size:0.8125rem;">
                <span><span class="category-tag rare">RARI</span> ${rare}</span>
                <span><span class="category-tag medium">MEDI</span> ${medium}</span>
                <span><span class="category-tag common">COMUNI</span> ${common}</span>
            </div>`;
        }

        function saveApiKey() {
            const key = document.getElementById('serper-key').value.trim();
            if (key) { localStorage.setItem('serper_api_key', key); showToast('Chiave salvata'); }
        }

        // ==========================================
        // SEARCH ENGINE v3.2
        // ==========================================

        async function startSearch() {
            const apiKey = document.getElementById('serper-key').value.trim() || localStorage.getItem('serper_api_key');
            if (!apiKey) return showToast('Inserisci la chiave API');

            const cognomi = getCognomi();
            if (cognomi.length === 0) return showToast('Carica almeno un cognome');

            const countries = Array.from(document.querySelectorAll('input[name="country"]:checked')).map(c => c.value);
            if (countries.length === 0) return showToast('Seleziona almeno un paese');

            const ageMin = parseInt(document.getElementById('age-min').value) || 16;
            const ageMax = parseInt(document.getElementById('age-max').value) || 28;
            const depth = parseInt(document.getElementById('search-depth').value);
            const resultsNum = parseInt(document.getElementById('results-num').value);
            const onlyProfiles = document.getElementById('only-profiles').checked;
            const bdfaPriority = document.getElementById('bdfa-priority').checked;

            document.getElementById('btn-search').disabled = true;
            document.getElementById('progress-wrapper').style.display = 'block';

            // Calcola totale ricerche
            let totalSearches = 0;
            for (const cognome of cognomi) {
                for (const country of countries) {
                    totalSearches += depth;
                    // Aggiungi ricerche BDFA dedicate se Argentina √® selezionata
                    if (bdfaPriority && country === 'Argentina') {
                        totalSearches += 2; // 2 query BDFA extra
                    }
                }
            }

            let completed = 0;
            let newCandidates = 0;

            for (const cognome of cognomi) {
                // PRIMA: Ricerche BDFA dedicate (se attivo)
                if (bdfaPriority && countries.includes('Argentina')) {
                    const bdfaQueries = buildBDFAQueries(cognome);
                    for (const query of bdfaQueries) {
                        try {
                            updateProgress(completed, totalSearches, `üá¶üá∑ BDFA: ${cognome}`);
                            const results = await searchSerper(apiKey, query, resultsNum);
                            const processed = processResults(results, cognome, 'Argentina', ageMin, ageMax, onlyProfiles, true);
                            newCandidates += processed;
                            completed++;
                            await sleep(400);
                        } catch (err) {
                            console.error('BDFA search error:', err);
                            completed++;
                        }
                    }
                }

                // POI: Ricerche standard per paese
                for (const country of countries) {
                    const queries = buildQueries(cognome, country, depth);
                    for (const query of queries) {
                        try {
                            updateProgress(completed, totalSearches, `${cognome} (${country})`);
                            const results = await searchSerper(apiKey, query, resultsNum);
                            const processed = processResults(results, cognome, country, ageMin, ageMax, onlyProfiles, false);
                            newCandidates += processed;
                            completed++;
                            await sleep(350);
                        } catch (err) {
                            console.error('Search error:', err);
                            completed++;
                        }
                    }
                }
            }

            document.getElementById('btn-search').disabled = false;
            document.getElementById('progress-wrapper').style.display = 'none';
            
            saveCandidates();
            showToast(`Completato: ${newCandidates} nuovi candidati`);
            switchTab('results');
        }

        // ==========================================
        // QUERY BUILDERS
        // ==========================================

        function buildBDFAQueries(cognome) {
            // Query ottimizzate per BDFA Argentina
            return [
                `site:bdfa.com.ar/jugadores "${cognome}"`,
                `site:bdfa.com.ar "${cognome}" nacionalidad argentina`
            ];
        }

        function buildQueries(cognome, country, depth) {
            const queries = [];
            
            if (country === 'Argentina') {
                // Transfermarkt Argentina
                queries.push(`site:transfermarkt.com/*/spieler/ "${cognome}" argentina`);
                if (depth >= 2) {
                    queries.push(`"${cognome}" futbolista argentino perfil -italy -italia -serie`);
                }
                if (depth >= 3) {
                    queries.push(`site:soccerway.com/players/ "${cognome}" argentina`);
                }
            } else if (country === 'Brazil') {
                queries.push(`site:transfermarkt.com/*/spieler/ "${cognome}" brazil brasileiro`);
                if (depth >= 2) {
                    queries.push(`site:ogol.com.br/jogador "${cognome}"`);
                }
                if (depth >= 3) {
                    queries.push(`"${cognome}" jogador brasileiro perfil -italy -italia`);
                }
            } else if (country === 'USA') {
                queries.push(`site:transfermarkt.com/*/spieler/ "${cognome}" usa american mls`);
                if (depth >= 2) {
                    queries.push(`"${cognome}" soccer player american profile mls -italy`);
                }
                if (depth >= 3) {
                    queries.push(`site:soccerway.com/players/ "${cognome}" usa`);
                }
            } else {
                // Generic per altri paesi
                queries.push(`site:transfermarkt.com/*/spieler/ "${cognome}" ${country}`);
                if (depth >= 2) {
                    queries.push(`"${cognome}" footballer ${country} profile -italy -italia`);
                }
            }

            return queries.slice(0, depth);
        }

        async function searchSerper(apiKey, query, num) {
            const response = await fetch('https://google.serper.dev/search', {
                method: 'POST',
                headers: { 'X-API-KEY': apiKey, 'Content-Type': 'application/json' },
                body: JSON.stringify({ q: query, num: num })
            });
            if (!response.ok) throw new Error(`API error: ${response.status}`);
            const data = await response.json();
            return data.organic || [];
        }

        // ==========================================
        // RESULT PROCESSING
        // ==========================================

        function processResults(results, cognome, country, ageMin, ageMax, onlyProfiles, isBDFASearch) {
            let added = 0;
            for (const result of results) {
                const analyzed = analyzeResult(result, cognome, country, ageMin, ageMax, onlyProfiles, isBDFASearch);
                if (!isDuplicate(analyzed)) {
                    candidates.push(analyzed);
                    added++;
                }
            }
            return added;
        }

        function analyzeResult(result, cognome, searchCountry, ageMin, ageMax, onlyProfiles, isBDFASearch) {
            const title = result.title || '';
            const snippet = result.snippet || '';
            const link = result.link || '';
            const fullText = `${title} ${snippet}`.toLowerCase();
            const linkLower = link.toLowerCase();

            const noiseReasons = [];
            let isPlayerProfile = false;
            let isBDFA = linkLower.includes('bdfa.com.ar');

            // ==========================================
            // CHECK PROFILO VALIDO
            // ==========================================
            
            for (const pattern of BLACKLIST.urlWhitelist) {
                if (linkLower.includes(pattern)) {
                    isPlayerProfile = true;
                    break;
                }
            }

            // BDFA √® sempre considerato profilo valido
            if (isBDFA && linkLower.includes('/jugadores')) {
                isPlayerProfile = true;
            }

            // ==========================================
            // BLACKLIST CHECKS
            // ==========================================
            
            for (const pattern of BLACKLIST.urlBlacklist) {
                if (linkLower.includes(pattern)) {
                    noiseReasons.push(`URL non valido`);
                    isPlayerProfile = false;
                    break;
                }
            }

            for (const club of BLACKLIST.clubsRSM) {
                if (fullText.includes(club)) {
                    noiseReasons.push(`Club RSM`);
                    break;
                }
            }

            for (const club of BLACKLIST.clubsItaly) {
                if (linkLower.includes(club)) {
                    noiseReasons.push(`Club italiano`);
                    break;
                }
            }

            for (const league of BLACKLIST.leagues) {
                if (fullText.includes(league)) {
                    noiseReasons.push(`Lega esclusa`);
                    break;
                }
            }

            for (const role of BLACKLIST.roles) {
                if (fullText.includes(role)) {
                    noiseReasons.push(`Non giocatore`);
                    break;
                }
            }

            for (const player of BLACKLIST.famousPlayers) {
                if (title.toLowerCase().includes(player)) {
                    noiseReasons.push(`Giocatore famoso`);
                    break;
                }
            }

            // Check indicatori italiani (solo se NON √® BDFA)
            if (!isBDFA) {
                for (const indicator of BLACKLIST.italianIndicators) {
                    if (fullText.includes(indicator)) {
                        noiseReasons.push('Giocatore italiano');
                        break;
                    }
                }
            }

            // Cognome presente?
            if (!fullText.includes(cognome.toLowerCase())) {
                noiseReasons.push('Cognome non trovato');
            }

            // Solo profili?
            if (onlyProfiles && !isPlayerProfile && noiseReasons.length === 0) {
                noiseReasons.push('Non profilo diretto');
            }

            // ==========================================
            // ESTRAZIONE DATI
            // ==========================================
            
            let playerName, detectedCountry, age, club, position;

            if (isBDFA) {
                // Parsing specifico BDFA
                const bdfaData = parseBDFA(title, snippet, link, cognome);
                playerName = bdfaData.name;
                detectedCountry = bdfaData.country;
                age = bdfaData.age;
                club = bdfaData.club;
                position = bdfaData.position;
            } else {
                // Parsing standard
                playerName = extractPlayerName(title, snippet, cognome);
                detectedCountry = detectCountry(fullText, searchCountry);
                age = extractAge(snippet, title);
                club = extractClub(snippet);
                position = extractPosition(fullText);
            }

            // Check et√†
            if (age) {
                const ageNum = parseInt(age);
                if (ageNum < ageMin) noiseReasons.push(`Troppo giovane (${age})`);
                if (ageNum > ageMax) noiseReasons.push(`Troppo vecchio (${age})`);
            }

            // ==========================================
            // SCORE
            // ==========================================
            
            const category = getCognomeCategory(cognome);
            let score = 0;
            
            if (category === 'rare') score += 4;
            else if (category === 'medium') score += 2;
            else score += 1;

            if (['Argentina', 'Brazil', 'USA'].includes(detectedCountry)) score += 2;
            if (noiseReasons.length === 0) score += 3;
            if (isPlayerProfile) score += 3;
            if (isBDFA) score += 4; // BONUS BDFA!
            if (age && parseInt(age) >= 18 && parseInt(age) <= 25) score += 1;
            if (position) score += 1;

            return {
                id: Date.now() + Math.random(),
                name: playerName,
                surname: cognome,
                category,
                country: detectedCountry,
                age,
                club,
                position,
                score,
                isNoise: noiseReasons.length > 0,
                isPlayerProfile,
                isBDFA,
                noiseReasons,
                title,
                snippet,
                link,
                addedAt: new Date().toISOString()
            };
        }

        // ==========================================
        // BDFA PARSER
        // ==========================================

        function parseBDFA(title, snippet, link, cognome) {
            // Formato BDFA tipico:
            // Title: "FABRIZIO GUIDI | Defensor | Argentina"
            // Snippet: "Nacionalidad: Argentina. Posici√≥n: Defensor. Fecha de nacimiento: 10/2/2003 (22 a√±os)..."
            // URL: bdfa.com.ar/jugadores-FABRIZIO-GUIDI-150927.html

            let name = '';
            let country = 'Argentina'; // Default per BDFA
            let age = '';
            let club = '';
            let position = '';

            // Estrai nome da URL (pi√π affidabile)
            const urlMatch = link.match(/jugadores-([A-Z\-]+)-\d+\.html/i);
            if (urlMatch) {
                name = urlMatch[1].replace(/-/g, ' ').trim();
                // Capitalizza correttamente
                name = name.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
            } else {
                // Fallback al titolo
                const titleParts = title.split('|');
                if (titleParts.length > 0) {
                    name = titleParts[0].trim();
                }
            }

            // Estrai posizione dal titolo o snippet
            const posMatch = title.match(/\|\s*(Arquero|Defensor|Mediocampista|Delantero|Lateral|Volante)/i) ||
                            snippet.match(/Posici√≥n:\s*(Arquero|Defensor|Mediocampista|Delantero|Lateral|Volante)/i);
            if (posMatch) {
                const posMap = {
                    'arquero': 'Portiere',
                    'defensor': 'Difensore',
                    'lateral': 'Terzino',
                    'mediocampista': 'Centrocampista',
                    'volante': 'Mediano',
                    'delantero': 'Attaccante'
                };
                position = posMap[posMatch[1].toLowerCase()] || posMatch[1];
            }

            // Estrai et√† da snippet
            const ageMatch = snippet.match(/\((\d{1,2})\s*a√±os?\)/i);
            if (ageMatch) {
                age = ageMatch[1];
            } else {
                // Prova con data di nascita
                const birthMatch = snippet.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                if (birthMatch) {
                    const birthYear = parseInt(birthMatch[3]);
                    age = (new Date().getFullYear() - birthYear).toString();
                }
            }

            // Estrai club da snippet (se presente)
            const clubMatch = snippet.match(/Club:\s*([^\.]+)/i) ||
                             snippet.match(/juega en\s+([^\.]+)/i);
            if (clubMatch) {
                club = clubMatch[1].trim().substring(0, 25);
            }

            // Verifica nazionalit√† (alcuni potrebbero essere stranieri in Argentina)
            if (snippet.toLowerCase().includes('nacionalidad:')) {
                const natMatch = snippet.match(/Nacionalidad:\s*([A-Za-z√°-√∫\s]+)/i);
                if (natMatch) {
                    const nat = natMatch[1].trim().toLowerCase();
                    if (nat.includes('argentin')) country = 'Argentina';
                    else if (nat.includes('brasil') || nat.includes('brazil')) country = 'Brazil';
                    else if (nat.includes('uruguay')) country = 'Uruguay';
                    else if (nat.includes('paragua')) country = 'Paraguay';
                    else country = natMatch[1].trim();
                }
            }

            return { name, country, age, club, position };
        }

        // ==========================================
        // STANDARD PARSERS
        // ==========================================

        function extractPlayerName(title, snippet, cognome) {
            const patterns = [
                new RegExp(`([A-Z][a-z√†-√ø]+)\\s+${cognome}`, 'i'),
                new RegExp(`${cognome},?\\s+([A-Z][a-z√†-√ø]+)`, 'i'),
                new RegExp(`([A-Z])\\.\\s*${cognome}`, 'i')
            ];

            for (const regex of patterns) {
                const match = title.match(regex) || snippet.match(regex);
                if (match) {
                    if (match[1].length === 1) return `${match[1]}. ${cognome}`;
                    return `${match[1]} ${cognome}`;
                }
            }

            const titleClean = title.split(' - ')[0].split(' | ')[0].trim();
            if (titleClean.length < 35 && titleClean.toLowerCase().includes(cognome.toLowerCase())) {
                return titleClean;
            }

            return `[Verifica] ${cognome}`;
        }

        function detectCountry(text, fallback) {
            const patterns = {
                'Argentina': ['argentina', 'argentino', 'buenos aires'],
                'Brazil': ['brazil', 'brasil', 'brasileiro'],
                'USA': ['usa', 'united states', 'american', 'mls'],
                'Uruguay': ['uruguay', 'uruguayo'],
                'Paraguay': ['paraguay', 'paraguayo'],
                'Chile': ['chile', 'chileno']
            };

            for (const [country, terms] of Object.entries(patterns)) {
                for (const term of terms) {
                    if (text.includes(term)) return country;
                }
            }
            return fallback;
        }

        function extractAge(snippet, title) {
            const combined = `${snippet} ${title}`;
            const patterns = [
                /\((\d{1,2})\s*a√±os?\)/i,
                /\((\d{1,2})\s*years?\)/i,
                /age[:\s]*(\d{1,2})/i,
                /(\d{1,2})\s*anni/i
            ];

            for (const pattern of patterns) {
                const match = combined.match(pattern);
                if (match && parseInt(match[1]) >= 14 && parseInt(match[1]) <= 50) {
                    return match[1];
                }
            }

            const yearMatch = combined.match(/\b(19[89]\d|200\d|201\d)\b/);
            if (yearMatch) {
                const age = new Date().getFullYear() - parseInt(yearMatch[1]);
                if (age >= 14 && age <= 50) return age.toString();
            }
            return '';
        }

        function extractClub(snippet) {
            const patterns = [
                /(?:club|plays? for|gioca per)[:\s]*([A-Za-z√Ä-√ø\s]+?)(?:\.|,|;|$)/i
            ];
            for (const pattern of patterns) {
                const match = snippet.match(pattern);
                if (match) return match[1].trim().substring(0, 25);
            }
            return '';
        }

        function extractPosition(text) {
            const positions = {
                'goalkeeper': 'Portiere', 'portiere': 'Portiere', 'arquero': 'Portiere',
                'defender': 'Difensore', 'difensore': 'Difensore', 'defensor': 'Difensore',
                'midfielder': 'Centrocampista', 'mediocampista': 'Centrocampista',
                'forward': 'Attaccante', 'delantero': 'Attaccante', 'striker': 'Punta'
            };
            const textLower = text.toLowerCase();
            for (const [key, value] of Object.entries(positions)) {
                if (textLower.includes(key)) return value;
            }
            return '';
        }

        function isDuplicate(candidate) {
            return candidates.some(c => 
                c.link === candidate.link ||
                (c.name === candidate.name && c.surname === candidate.surname && c.country === candidate.country)
            );
        }

        // ==========================================
        // RENDERING
        // ==========================================

        function renderResults() {
            updateStats();
            const container = document.getElementById('results-container');
            
            let filtered = candidates;
            switch (currentFilter) {
                case 'valid': filtered = candidates.filter(c => !c.isNoise); break;
                case 'bdfa': filtered = candidates.filter(c => !c.isNoise && c.isBDFA); break;
                case 'priority': filtered = candidates.filter(c => !c.isNoise && c.score >= 10); break;
                case 'filtered': filtered = candidates.filter(c => c.isNoise); break;
            }

            if (filtered.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üì≠</div><div class="empty-state-title">Nessun risultato</div></div>`;
                return;
            }

            filtered.sort((a, b) => b.score - a.score);
            container.innerHTML = filtered.map(c => renderResultCard(c)).join('');
        }

        function renderResultCard(c) {
            const badgeClass = c.isNoise ? 'badge-noise' : (c.score >= 10 ? 'badge-high' : (c.score >= 6 ? 'badge-medium' : 'badge-low'));
            const badgeText = c.isNoise ? 'FILTRATO' : (c.score >= 10 ? 'PRIORIT√Ä ALTA' : (c.score >= 6 ? 'PRIORIT√Ä MEDIA' : 'PRIORIT√Ä BASSA'));
            const isVerified = verified.some(v => v.id === c.id);
            
            const highlightedSnippet = c.snippet.replace(new RegExp(`(${c.surname})`, 'gi'), '<mark>$1</mark>');

            return `
                <div class="result-card ${c.isNoise ? 'noise' : ''} ${isVerified ? 'verified' : ''} ${c.isBDFA ? 'bdfa-source' : (c.isPlayerProfile ? 'player-profile' : '')}">
                    <div class="result-header">
                        <span class="result-name">${c.name}</span>
                        <div class="result-badges">
                            ${c.isBDFA ? '<span class="badge badge-bdfa">üá¶üá∑ BDFA</span>' : ''}
                            ${c.isPlayerProfile && !c.isBDFA && !c.isNoise ? '<span class="badge badge-profile">PROFILO</span>' : ''}
                            ${isVerified ? '<span class="badge badge-verified">‚úì</span>' : ''}
                            <span class="badge ${badgeClass}">${badgeText}</span>
                        </div>
                    </div>
                    <div class="result-body">
                        <div class="result-meta">
                            <span class="category-tag ${c.category}">${c.surname}</span>
                            ${c.country ? `<span class="result-meta-item"><span class="icon">üåç</span> ${c.country}</span>` : ''}
                            ${c.age ? `<span class="result-meta-item"><span class="icon">üìÖ</span> ${c.age} anni</span>` : ''}
                            ${c.club ? `<span class="result-meta-item"><span class="icon">‚öΩ</span> ${c.club}</span>` : ''}
                            ${c.position ? `<span class="result-meta-item"><span class="icon">üë§</span> ${c.position}</span>` : ''}
                            <span class="result-meta-item"><span class="icon">‚≠ê</span> ${c.score}</span>
                        </div>
                        <div class="result-snippet">${highlightedSnippet}</div>
                        ${c.isNoise ? `<div class="result-noise-reason">‚ö†Ô∏è ${c.noiseReasons.join(' ‚Ä¢ ')}</div>` : ''}
                        <div class="result-link"><a href="${c.link}" target="_blank">${c.link}</a></div>
                    </div>
                    <div class="result-footer">
                        <div class="result-actions">
                            ${!c.isNoise ? `
                                <button class="btn btn-sm ${isVerified ? 'btn-success' : 'btn-secondary'}" onclick="toggleVerify(${c.id})">
                                    ${isVerified ? '‚úì Selezionato' : '‚òê Seleziona'}
                                </button>
                            ` : `
                                <button class="btn btn-sm btn-secondary" onclick="restoreCandidate(${c.id})">‚ôªÔ∏è</button>
                            `}
                            <button class="btn btn-sm btn-danger" onclick="removeCandidate(${c.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderVerified() {
            updateVerifiedStats();
            const container = document.getElementById('verified-container');

            if (verified.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-title">Nessun candidato selezionato</div></div>`;
                return;
            }

            container.innerHTML = verified.map(c => `
                <div class="result-card verified ${c.isBDFA ? 'bdfa-source' : ''}">
                    <div class="result-header">
                        <span class="result-name">${c.name}</span>
                        <div class="result-badges">
                            ${c.isBDFA ? '<span class="badge badge-bdfa">üá¶üá∑ BDFA</span>' : ''}
                            <span class="category-tag ${c.category}">${c.surname}</span>
                        </div>
                    </div>
                    <div class="result-body">
                        <div class="result-meta">
                            ${c.country ? `<span class="result-meta-item">üåç ${c.country}</span>` : ''}
                            ${c.age ? `<span class="result-meta-item">üìÖ ${c.age} anni</span>` : ''}
                            ${c.club ? `<span class="result-meta-item">‚öΩ ${c.club}</span>` : ''}
                            ${c.position ? `<span class="result-meta-item">üë§ ${c.position}</span>` : ''}
                        </div>
                        <div class="result-link"><a href="${c.link}" target="_blank">${c.link}</a></div>
                    </div>
                    <div class="result-footer">
                        <button class="btn btn-sm btn-danger" onclick="removeVerified(${c.id})">‚ùå</button>
                    </div>
                </div>
            `).join('');
        }

        // ==========================================
        // ACTIONS
        // ==========================================

        function toggleVerify(id) {
            const candidate = candidates.find(c => c.id === id);
            if (!candidate) return;
            const idx = verified.findIndex(v => v.id === id);
            if (idx >= 0) { verified.splice(idx, 1); showToast('Rimosso'); }
            else { verified.push(candidate); showToast('Aggiunto'); }
            saveVerified();
            renderResults();
        }

        function restoreCandidate(id) {
            const c = candidates.find(c => c.id === id);
            if (c) { c.isNoise = false; c.noiseReasons = []; saveCandidates(); renderResults(); showToast('Ripristinato'); }
        }

        function removeCandidate(id) {
            candidates = candidates.filter(c => c.id !== id);
            verified = verified.filter(v => v.id !== id);
            saveCandidates(); saveVerified(); renderResults();
        }

        function removeVerified(id) {
            verified = verified.filter(v => v.id !== id);
            saveVerified(); renderVerified();
        }

        function clearResults() {
            if (confirm('Eliminare tutto?')) {
                candidates = []; verified = [];
                saveCandidates(); saveVerified(); renderResults();
                showToast('Pulito');
            }
        }

        // ==========================================
        // STATS
        // ==========================================

        function updateStats() {
            const valid = candidates.filter(c => !c.isNoise);
            const bdfa = valid.filter(c => c.isBDFA);
            const filtered = candidates.filter(c => c.isNoise);

            document.getElementById('stat-total').textContent = candidates.length;
            document.getElementById('stat-valid').textContent = valid.length;
            document.getElementById('stat-bdfa').textContent = bdfa.length;
            document.getElementById('stat-filtered').textContent = filtered.length;
        }

        function updateVerifiedStats() {
            const bdfa = verified.filter(c => c.isBDFA);
            document.getElementById('stat-verified-count').textContent = verified.length;
            document.getElementById('stat-verified-bdfa').textContent = bdfa.length;
        }

        // ==========================================
        // EXPORT
        // ==========================================

        function generateReportHTML() {
            const title = document.getElementById('report-title').value || 'Candidati Oriundi';
            const notes = document.getElementById('report-notes').value;
            const date = new Date().toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric' });

            const bdfaCount = verified.filter(c => c.isBDFA).length;

            return `<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>${title}</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'IBM Plex Sans',sans-serif;background:#f5f5f5;padding:40px;line-height:1.6}
        .report{max-width:800px;margin:0 auto;background:#fff;padding:48px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
        .header{text-align:center;padding-bottom:32px;border-bottom:2px solid #e0e0e0;margin-bottom:32px}
        .logo{font-size:0.875rem;color:#666;letter-spacing:2px;margin-bottom:8px}
        .title{font-size:1.75rem;font-weight:700;margin-bottom:8px}
        .subtitle{font-size:0.875rem;color:#666}
        .watermark{display:inline-block;background:#dc2626;color:#fff;padding:8px 20px;border-radius:4px;font-size:0.75rem;font-weight:700;letter-spacing:1px;margin-top:16px}
        .disclaimer{background:#fef3c7;border-left:4px solid #f59e0b;color:#92400e;padding:16px;margin-bottom:32px;font-size:0.875rem}
        .notes{background:#f0f9ff;border-left:4px solid #0ea5e9;color:#0369a1;padding:16px;margin-bottom:32px;font-size:0.875rem}
        .stats{display:flex;gap:16px;margin-bottom:24px}
        .stat{flex:1;background:#f5f5f5;padding:16px;border-radius:8px;text-align:center}
        .stat-value{font-size:1.5rem;font-weight:700;color:#2f81f7}
        .stat-value.bdfa{color:#00a8e8}
        .stat-label{font-size:0.75rem;color:#666}
        .section-title{font-size:1rem;font-weight:600;margin-bottom:16px;padding-bottom:8px;border-bottom:1px solid #e0e0e0}
        .candidate{border:1px solid #e0e0e0;border-radius:8px;margin-bottom:16px;overflow:hidden;page-break-inside:avoid}
        .candidate.bdfa{border-left:4px solid #00a8e8}
        .candidate-header{background:#f5f5f5;padding:12px 16px;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center}
        .candidate-name{font-weight:600}
        .candidate-badge{background:#1f2937;color:#fff;padding:4px 12px;border-radius:12px;font-size:0.6875rem;font-weight:600}
        .candidate-badge.bdfa{background:#00a8e8}
        .candidate-body{padding:16px}
        .candidate-meta{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px}
        .meta-label{color:#666;font-size:0.6875rem;text-transform:uppercase}
        .candidate-link{font-size:0.75rem;color:#2563eb;word-break:break-all}
        .footer{margin-top:40px;padding-top:24px;border-top:2px solid #e0e0e0;text-align:center;font-size:0.75rem;color:#666}
        .footer-watermark{color:#dc2626;font-weight:600;margin-top:8px}
        @media print{body{padding:0;background:#fff}.report{box-shadow:none;padding:24px}}
    </style>
</head>
<body>
    <div class="report">
        <div class="header">
            <div class="logo">TITAN VERITAS v3.2 ‚Ä¢ HERITAGE INTELLIGENCE</div>
            <h1 class="title">${title}</h1>
            <div class="subtitle">Generato il ${date} ‚Ä¢ ${verified.length} candidati</div>
            <div class="watermark">‚ö†Ô∏è CONFIDENZIALE ‚Äî DA VERIFICARE IN ANAGRAFE</div>
        </div>

        <div class="disclaimer">
            <strong>AVVERTENZA:</strong> Dati preliminari da fonti pubbliche. Richiedono verifica ufficiale tramite anagrafe RSM.
        </div>

        ${notes ? `<div class="notes"><strong>Note:</strong> ${notes}</div>` : ''}

        <div class="stats">
            <div class="stat">
                <div class="stat-value">${verified.length}</div>
                <div class="stat-label">Totale Candidati</div>
            </div>
            <div class="stat">
                <div class="stat-value bdfa">${bdfaCount}</div>
                <div class="stat-label">Da BDFA Argentina</div>
            </div>
        </div>

        <div class="section-title">üìã Candidati Selezionati</div>

        ${verified.map(c => `
            <div class="candidate ${c.isBDFA ? 'bdfa' : ''}">
                <div class="candidate-header">
                    <span class="candidate-name">${c.name}</span>
                    <span class="candidate-badge ${c.isBDFA ? 'bdfa' : ''}">${c.isBDFA ? 'üá¶üá∑ BDFA' : c.category.toUpperCase()}</span>
                </div>
                <div class="candidate-body">
                    <div class="candidate-meta">
                        <div><div class="meta-label">Cognome</div><div>${c.surname}</div></div>
                        <div><div class="meta-label">Paese</div><div>${c.country || 'N/D'}</div></div>
                        <div><div class="meta-label">Et√†</div><div>${c.age ? c.age + ' anni' : 'N/D'}</div></div>
                        <div><div class="meta-label">Club</div><div>${c.club || 'N/D'}</div></div>
                        <div><div class="meta-label">Ruolo</div><div>${c.position || 'N/D'}</div></div>
                        <div><div class="meta-label">Score</div><div>${c.score}/15</div></div>
                    </div>
                    <div class="candidate-link">üîó ${c.link}</div>
                </div>
            </div>
        `).join('')}

        <div class="footer">
            <div>Report generato da TITAN VERITAS Intelligence Platform v3.2</div>
            <div>Federazione Sammarinese Giuoco Calcio ‚Äî Uso Interno</div>
            <div class="footer-watermark">CONFIDENZIALE ‚Äî DA VERIFICARE IN ANAGRAFE RSM</div>
        </div>
    </div>
</body>
</html>`;
        }

        function previewReport() {
            if (verified.length === 0) return showToast('Nessun candidato');
            document.getElementById('modal-body').innerHTML = `<iframe srcdoc="${generateReportHTML().replace(/"/g, '&quot;')}" style="width:100%;height:500px;border:none;border-radius:8px;"></iframe>`;
            document.getElementById('modal-overlay').classList.add('active');
        }

        function closeModal() { document.getElementById('modal-overlay').classList.remove('active'); }

        function downloadHTML() {
            if (verified.length === 0) return showToast('Nessun candidato');
            const blob = new Blob([generateReportHTML()], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `TITAN_VERITAS_Report_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            showToast('HTML scaricato');
        }

        function downloadCSV() {
            if (verified.length === 0) return showToast('Nessun candidato');
            const headers = ['Nome','Cognome','Categoria','Paese','Et√†','Club','Ruolo','Score','BDFA','Link'];
            const rows = verified.map(c => [c.name,c.surname,c.category,c.country,c.age,c.club,c.position,c.score,c.isBDFA?'S√¨':'No',c.link]);
            const csv = [headers,...rows].map(r => r.map(c => `"${(c||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
            const blob = new Blob(['\ufeff'+csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `TITAN_VERITAS_Export_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            showToast('CSV scaricato');
        }

        function printReport() {
            const win = window.open('', '_blank');
            win.document.write(generateReportHTML());
            win.document.close();
            setTimeout(() => win.print(), 500);
        }

        // ==========================================
        // PERSISTENCE
        // ==========================================

        function saveCandidates() { localStorage.setItem('titan_v32_candidates', JSON.stringify(candidates)); updateStats(); }
        function saveVerified() { localStorage.setItem('titan_v32_verified', JSON.stringify(verified)); }

        // ==========================================
        // UTILS
        // ==========================================

        function updateProgress(current, total, text) {
            document.getElementById('progress-fill').style.width = `${Math.round((current/total)*100)}%`;
            document.getElementById('progress-label').textContent = `${text} (${current}/${total})`;
        }

        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
